!function(e){function t(t){for(var i,a,c=t[0],s=t[1],u=t[2],l=0,d=[];l<c.length;l++)a=c[l],Object.prototype.hasOwnProperty.call(r,a)&&r[a]&&d.push(r[a][0]),r[a]=0;for(i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);for(h&&h(t);d.length;)d.shift()();return o.push.apply(o,u||[]),n()}function n(){for(var e,t=0;t<o.length;t++){for(var n=o[t],i=!0,c=1;c<n.length;c++){var s=n[c];0!==r[s]&&(i=!1)}i&&(o.splice(t--,1),e=a(a.s=n[0]))}return e}var i={},r={69:0},o=[];function a(t){if(i[t])return i[t].exports;var n=i[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=i,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(n,i,function(t){return e[t]}.bind(null,i));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="";var c=window.webpackJsonp=window.webpackJsonp||[],s=c.push.bind(c);c.push=t,c=c.slice();for(var u=0;u<c.length;u++)t(c[u]);var h=s;o.push([1262,2]),n()}({1262:function(e,t,n){e.exports=n(1302)},1302:function(e,t,n){"use strict";n.r(t);var i=n(33),r=n(557),o=n(558);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t,n){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"styleElement",void 0),c(this,"channels",void 0),c(this,"staticStyles",void 0),c(this,"currentChannel",void 0),c(this,"currentVariant",void 0),c(this,"destroy",(function(){i.a.bus.off("Variants:changed",r.updateVariant),i.a.bus.off("SchEngine:didDocumentAttach",r.setChannel),i.a.bus.off("SchEngine:didDocumentDettach",r.destroy)})),c(this,"updateVariant",(function(e){null!=e&&e.projectVariant&&r.setVariant(e.projectVariant.uniqueId)})),c(this,"setVariant",(function(e){r.currentVariant!==e&&(r.currentVariant=e,r.update())})),c(this,"setChannel",(function(e){var t=r.getChannel(e);r.currentChannel!==t&&(r.currentChannel=t,r.update())})),this.staticStyles=" .activeMouse {pointer-events:all} .activeMouse:hover {cursor:pointer} .highlightedComponent {stroke:#868BFF; stroke-width:2px} text { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; } text::selection { background: none; }",this.currentChannel="",this.currentVariant=i.c,this.channels=null==n?void 0:n.channels,this.styleElement=document.createElement("style"),t.insertBefore(this.styleElement,t.firstChild),this.update(),i.a.bus.on("Variants:changed",this.updateVariant),i.a.bus.on("SchEngine:didDocumentAttach",this.setChannel),i.a.bus.on("SchEngine:didDocumentDettach",this.destroy)}var t,n,r;return t=e,(n=[{key:"addStyle",value:function(e){this.staticStyles=this.staticStyles+" "+e,this.update()}},{key:"update",value:function(){var e=this.staticStyles;e+=" [data-variant-id] { visibility: hidden }",e+=" .activeMouse[data-variant-id] { pointer-events:none }";var t=this.currentVariant===i.c?"":this.currentChannel;e+=' [data-variant-id~="'.concat(this.currentVariant).concat(t,'"] { visibility: visible }'),e+=' .activeMouse[data-variant-id~="'.concat(this.currentVariant).concat(t,'"] { pointer-events:all }'),this.styleElement.innerHTML=e}},{key:"getChannel",value:function(e){var t,n;if(!e||0===e.channelId||!this.channels)return"";var i=this.channels.filter((function(t){return t.schId===e.documentId&&t.inDM}));if(i.length<=1)return"";if(i.every((function(e){return e.name===i[0].name})))return"";var r=i.find((function(t){return t.id===e.channelId}));return null!==(t=null!==(n=null==r?void 0:r.safeName)&&void 0!==n?n:null==r?void 0:r.name)&&void 0!==t?t:""}}])&&a(t.prototype,n),r&&a(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),u=n(339);function h(e){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){w(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t){return(f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function v(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=p(e);if(t){var r=p(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===h(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function b(e,t,n){return t&&y(e.prototype,t),n&&y(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function S(e,t){return"EMPTY"===e?new E:"ERROR"===e?new I(t()):new D(t())}var k=function(e,t){i.a.bus.emit(e,t)},E=function(){function e(){g(this,e),w(this,"errorState",null),w(this,"state",{zoom:0,top:0,left:0}),w(this,"useAnimatedZoomToFit",!1)}return b(e,[{key:"type",get:function(){return"EMPTY"}},{key:"documentId",get:function(){return""}},{key:"uniqueId",get:function(){return""}},{key:"channelId",get:function(){return 0}},{key:"render",value:function(){return Promise.resolve()}},{key:"zoom",value:function(){}},{key:"zoomToFit",value:function(){return Promise.resolve()}},{key:"move",value:function(){}},{key:"destroy",value:function(){}}]),e}(),I=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}(n,e);var t=v(n);function n(e){var i;return g(this,n),i=t.call(this),setTimeout((function(){return k("SchEngine:didDocumentAttachError",{error:e.errorState,documentId:e.documentId})}),0),i}return b(n)}(E),D=function(){function e(t){var n=this;g(this,e),w(this,"svg",void 0),w(this,"id",void 0),w(this,"unique",void 0),w(this,"channel",void 0),w(this,"scene",void 0),w(this,"workspace",void 0),w(this,"position",{x:0,y:0}),w(this,"originSize",{width:0,height:0}),w(this,"currentSize",{width:0,height:0}),w(this,"zoomRelativePoint",{x:0,y:0}),w(this,"scale",100),w(this,"spaceVisibilityService",void 0),w(this,"selectionService",void 0),w(this,"fitToZoomNeed",!1),w(this,"logger",i.a.createLogger("SchDocumentRenderer")),w(this,"selectionGroup",void 0),w(this,"selectionMaskGroup",void 0),w(this,"highlightGroup",void 0),w(this,"maskId",void 0),w(this,"maskPath",null),w(this,"selectMask",null),w(this,"selectBound",null),w(this,"styleManager",void 0),w(this,"onTransformUpdate",void 0),w(this,"overlay",void 0),w(this,"sceneInfo",void 0),w(this,"errorState",null),w(this,"useAnimatedZoomToFit",!1),w(this,"onDrawSelection",(function(e){n.logger.LogDebug("Draw selection");var t=0,i=0,r=0,o=0;if(e.items.forEach((function(e){e.channel&&e.channel!==n.channelId||n.selectionService.getActiveObjectsForItem(e).forEach((function(e){e&&(n.drawSelection(e),e.bounds&&e.bounds.forEach((function(e){i=i?Math.min(i,e.x):e.x,t=t?Math.min(t,e.y):e.y,r=r?Math.max(r,e.x+e.width):e.x+e.width,o=o?Math.max(o,e.y+e.height):e.y+e.height})))}))})),e.fit&&r-i&&o-t){var a,c={x:i,y:t,width:r-i,height:o-t};n.zoomToFit(c,!0,null!==(a=e.fitZoom)&&void 0!==a?a:.7)}})),w(this,"drawHighlight",(function(e){var t=e.localName;if(n.isRectBox(e))e.setAttribute("stroke-width","2px"),e.setAttribute("stroke","#868BFF");else if("line"===t||"polyline"===t||"rect"===t||"path"===t){var i=window.getComputedStyle(e)["stroke-width"],r=1;i.match(/^\-?\d+(\.?\d*)px$/)&&(r=parseFloat(i.substring(0,i.length-2))),e.setAttribute("stroke-width","".concat(r+2,"px"))}n.highlightGroup.appendChild(e)})),w(this,"clearHighlight",(function(){for(;n.highlightGroup.firstChild;)n.highlightGroup.removeChild(n.highlightGroup.firstChild)})),w(this,"debounceEmitDocumentLocation",Object(u.a)((function(){k("SchEngine:documentLocation",d(d({},n.state),{},{type:"sch"}))}),250)),this.logger.LogDebug("Create for "+t.documentId),this.id=t.documentId,this.unique=t.uniqueId,this.channel=t.channelId,this.workspace=t.workspace,this.svg=t.workspace.appendChild(t.node),this.svg.style.opacity="0",this.scene=this.svg.getElementById("scene"),this.sceneInfo=this.getSceneInfo(),this.maskId="".concat(this.scene.id,"_selection_mask"),this.selectionService=t.selectionService,this.originSize.width=this.svg.width.baseVal.value,this.originSize.height=this.svg.height.baseVal.value,this.svg.setAttribute("viewBox","0 0 ".concat(this.svg.width.baseVal.value," ").concat(this.svg.height.baseVal.value)),this.svg.setAttribute("width","".concat(this.originSize.width)),this.svg.setAttribute("height","".concat(this.originSize.height)),this.svg.setAttribute("style","width: 100%; height: 100%"),this.spaceVisibilityService=this.createSpaceVisibilityService(this.workspace),this.selectionMaskGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.selectionMaskGroup.id=this.scene.id+"SelectionMask",this.scene.appendChild(this.selectionMaskGroup),this.selectionGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.selectionGroup.id=this.scene.id+"Selection",this.scene.appendChild(this.selectionGroup),this.highlightGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.highlightGroup.id=this.scene.id+"Highlight",this.scene.appendChild(this.highlightGroup),this.createMask(),this.overlay=document.createElementNS("http://www.w3.org/2000/svg","g"),this.overlay.id=this.scene.id+"Overlay",this.scene.appendChild(this.overlay);var r=new CustomEvent("didTransformChange",{detail:this.scene.transform});this.overlay.didTransformChangeEvent=r,this.onTransformUpdate=function(){return n.overlay.dispatchEvent(r)},this.styleManager=new s(this.svg,t.metadata),setTimeout((function(e){return k("SchEngine:didDocumentAttach",{workspace:n.workspace,svg:n.svg,styleManager:n.styleManager,overlay:n.overlay,uniqueId:n.uniqueId,channelId:n.channelId,documentId:n.documentId,documentWidth:n.originSize.width,documentHeight:n.originSize.height})}),0),this.clearSelection=this.clearSelection.bind(this),this.doSetupChannel(t.metadata),i.a.bus.on("SchEngine:clearHighlight",this.clearHighlight),i.a.bus.on("SchEngine:drawHighlight",this.drawHighlight),i.a.bus.on("SchEngine:clearSelection",this.clearSelection),i.a.bus.on("SchEngine:drawSelection",this.onDrawSelection)}return b(e,[{key:"type",get:function(){return"DEFAULT"}},{key:"documentId",get:function(){return this.id}},{key:"uniqueId",get:function(){return this.unique}},{key:"channelId",get:function(){return this.channel}},{key:"state",get:function(){return{zoom:this.scale,top:this.position.y,left:this.position.x}},set:function(e){this.scale=e.zoom,this.position.x=e.left,this.position.y=e.top,this.updateTransform()}},{key:"render",value:function(){var e=this;return new Promise((function(t){e.svg.style.opacity="1",e.spaceVisibilityService.onWindowResize();var n=e.selectionService.setupDocument(e);n&&e.scene.insertBefore(n,e.overlay),t()}))}},{key:"zoom",value:function(e,t,n){this.setZoomRelativePoint(e,t);var i=this.scale*(100-n)/100;this.doZoom(i),k("SchEngine:documentZoom",{type:"zoom",documentId:this.documentId,scale:i,x:e,y:t}),this.debounceEmitDocumentLocation()}},{key:"zoomToFit",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.9;return new Promise((function(r){new Promise((function(r){e?r(d(d({},e),{margin:i,changeScale:t})):n.spaceVisibilityService.displayed?(!0,r({x:0,y:0,width:n.sceneInfo.width,height:n.sceneInfo.height,margin:i,changeScale:t})):n.fitToZoomNeed=!0})).then((function(e){return n.zoomRectangleToFit(e.x,e.y,e.width,e.height,e.margin,e.changeScale)})).then((function(){n.updateTransform(),r()})).catch((function(e){n.logger.LogError(e.message),r()})).finally((function(){k("SchEngine:documentLocation",d(d({},n.state),{},{type:"sch"}))}))}))}},{key:"move",value:function(e,t){var n=Math.min(this.spaceVisibilityService.size.width/this.sceneInfo.width,this.spaceVisibilityService.size.height/this.sceneInfo.height);n&&(this.position.x+=e/n,this.position.y+=t/n,this.updateTransform())}},{key:"destroy",value:function(){this.logger.LogDebug("Destroy for "+this.id),i.a.bus.off("SchEngine:clearHighlight",this.clearHighlight),i.a.bus.off("SchEngine:drawHighlight",this.drawHighlight),i.a.bus.off("SchEngine:clearSelection",this.clearSelection),i.a.bus.off("SchEngine:drawSelection",this.onDrawSelection),k("SchEngine:didDocumentDettach",null);try{this.spaceVisibilityService.destroy(),this.workspace&&(this.workspace.removeChild(this.svg),this.workspace=null)}catch(e){this.logger.LogError("Destroy renderer error. ".concat(e.message))}}},{key:"createMask",value:function(){var e=document.createElementNS("http://www.w3.org/2000/svg","defs"),t=document.createElementNS("http://www.w3.org/2000/svg","mask");t.setAttribute("id",this.maskId),t.setAttribute("maskContentUnits","userSpaceOnUse"),e.appendChild(t);var n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("width","".concat(this.originSize.width)),n.setAttribute("height","".concat(this.originSize.height)),n.setAttribute("fill","white"),n.setAttribute("opacity","0.3"),t.appendChild(n),this.maskPath=document.createElementNS("http://www.w3.org/2000/svg","path"),this.maskPath.setAttribute("fill","black"),t.appendChild(this.maskPath),this.scene.insertBefore(e,this.scene.firstChild),this.selectMask=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.selectMask.setAttribute("width","".concat(this.originSize.width)),this.selectMask.setAttribute("height","".concat(this.originSize.height)),this.selectMask.setAttribute("mask","url(#".concat(this.maskId,")")),this.selectMask.setAttribute("fill","grey"),this.selectMask.style.visibility="hidden",this.selectionMaskGroup.appendChild(this.selectMask),this.selectBound=document.createElementNS("http://www.w3.org/2000/svg","path"),this.selectBound.setAttribute("stroke","blue"),this.selectBound.setAttribute("stroke-width","3px"),this.selectBound.setAttribute("mask","url(#".concat(this.maskId,")")),this.selectBound.style.visibility="hidden",this.selectionMaskGroup.appendChild(this.selectBound)}},{key:"drawSelection",value:function(e){if(this.maskPath){if(e&&e.bounds){var t=e.bounds.map((function(e){return"M".concat(e.x," ").concat(e.y," H").concat(e.x+e.width," V").concat(e.y+e.height," H").concat(e.x," Z")})).join(" "),n=this.maskPath.getAttribute("d");n?this.maskPath.setAttribute("d",n+" "+t):this.maskPath.setAttribute("d",t),this.selectBound&&(this.selectBound.setAttribute("d",this.maskPath.getAttribute("d")),this.selectBound.style.visibility="visible"),this.selectMask&&(this.selectMask.style.visibility="visible")}if(e&&e.element){var i=e.element,r=i.localName;if("line"===r||"polyline"===r||"rect"===r||"path"===r){var o=window.getComputedStyle(i)["stroke-width"],a=1;o.match(/^\-?\d+(\.?\d*)px$/)&&(a=parseFloat(o.substring(0,o.length-2))),i.setAttribute("stroke-width","".concat(a+2,"px"))}this.selectionGroup.appendChild(i)}}}},{key:"isRectBox",value:function(e){if("rect"===e.localName){var t=e.rx.baseVal.value,n=e.ry.baseVal.value;return!t&&!n}return!1}},{key:"clearSelection",value:function(e){if(this.maskPath)for(this.maskPath.setAttribute("d",""),e.update||(this.selectBound&&(this.selectBound.style.visibility="hidden"),this.selectMask&&(this.selectMask.style.visibility="hidden"));this.selectionGroup.firstChild;)this.selectionGroup.removeChild(this.selectionGroup.firstChild)}},{key:"createSpaceVisibilityService",value:function(e){var t=this,n=new o.a(e);return n.on("didSizeChange",(function(){t.currentSize.width=n.size.width,t.currentSize.height=n.size.height,setTimeout((function(){t.onTransformUpdate&&t.onTransformUpdate()}),0)})),n.on("shown",(function(){t.fitToZoomNeed&&(t.fitToZoomNeed=!1,t.zoomToFit(null,!0)),t.currentSize.width=n.size.width,t.currentSize.height=n.size.height,setTimeout((function(){t.onTransformUpdate&&t.onTransformUpdate()}),0)})),n.on("hidden",(function(){})),n.displayed&&(this.currentSize.width=n.size.width,this.currentSize.height=n.size.height),n}},{key:"updateTransform",value:function(){var e="matrix(".concat(this.scale/100," 0 0 ").concat(this.scale/100," ").concat(this.position.x," ").concat(this.position.y,")");isNaN(this.scale)||isNaN(this.position.x)||isNaN(this.position.y)?this.logger.LogError("Transform value IsNAN"):(this.scene.setAttribute("transform",e),this.onTransformUpdate&&this.onTransformUpdate())}},{key:"setZoomRelativePoint",value:function(e,t){this.zoomRelativePoint.x=e,this.zoomRelativePoint.y=t}},{key:"zoomRectangleToFit",value:function(e,t,n,i,r,o){var a=this;return new Promise((function(c,s){if(a.sceneInfo.width&&a.sceneInfo.height)if(r<0||r>1)s(new Error("Margin [".concat(r,"] wrong value.")));else{var u=a.spaceVisibilityService.size.width,h=a.spaceVisibilityService.size.height;if(n&&0!==n&&i&&0!==i){r=Math.min(u,h)*(1-r)/2;var l=Math.min(a.spaceVisibilityService.size.width/a.sceneInfo.width,a.spaceVisibilityService.size.height/a.sceneInfo.height),d=a.spaceVisibilityService.size.width-a.sceneInfo.width*l,f=a.spaceVisibilityService.size.height-a.sceneInfo.height*l;if(l){var v=u-2*r-d,m=h-2*r-f,p=v/n,g=m/i,y=a.scale/100,b={lastX:a.position.x,lastY:a.position.y,lastScale:y};o&&(y=Math.abs(Math.min(p,g)),a.scale=Math.round(100*y)/l);var w=r+(v-n*y)/2,S=r+(m-i*y)/2;a.position.x=(-e*y+w)/l,a.position.y=(-t*y+S)/l,c(b)}}}}))}},{key:"animate",value:function(e,t,n,i){var r=this;return new Promise((function(o){if(r.useAnimatedZoomToFit&&i&&Math.min(r.spaceVisibilityService.size.width/r.sceneInfo.width,r.spaceVisibilityService.size.height/r.sceneInfo.height)){var a=r.position.x,c=r.position.y,s=r.scale/100,u=document.getElementById("animateTransformTranslateSchSvg");u||((u=document.createElementNS("http://www.w3.org/2000/svg","animateTransform")).setAttribute("id","animateTransformTranslateSchSvg"),u.setAttribute("attributeName","transform"),u.setAttribute("type","translate"),u.setAttribute("dur","0.4s"),r.scene.appendChild(u)),u.setAttribute("from","".concat(e,",").concat(t)),u.setAttribute("to","".concat(a,",").concat(c));var h=document.getElementById("animateTransformScaleSchSvg");h||((h=document.createElementNS("http://www.w3.org/2000/svg","animateTransform")).setAttribute("id","animateTransformScaleSchSvg"),h.setAttribute("attributeName","transform"),h.setAttribute("type","scale"),h.setAttribute("dur","0.4s"),h.setAttribute("additive","sum"),r.scene.appendChild(h)),h.setAttribute("from","".concat(n)),h.setAttribute("to","".concat(s)),u.beginElement&&h.beginElement&&(h.beginElement(),u.beginElement(),h.onEnd=function(){r.logger.LogDebug("Animation end")})}o()}))}},{key:"checkZoomRelativePoint",value:function(){-1===this.zoomRelativePoint.x&&-1===this.zoomRelativePoint.y&&(this.zoomRelativePoint.x=this.spaceVisibilityService.size.width/2,this.zoomRelativePoint.y=this.spaceVisibilityService.size.height/2)}},{key:"getRelativePoint",value:function(e,t,n){return e<t?t:e>n?n:e}},{key:"doZoom",value:function(e){var t=this.scene.getScreenCTM();if(t){this.checkZoomRelativePoint();var n=(e-this.scale)/100,i=this.sceneInfo.width*n,r=this.sceneInfo.height*n,o=t.e,a=this.sceneInfo.width*t.a,c=t.f,s=this.sceneInfo.height*t.a,u=this.getRelativePoint(this.zoomRelativePoint.x,o,o+a),h=this.getRelativePoint(this.zoomRelativePoint.y,c,c+s);this.position.x-=i*(u-o)/a,this.position.y-=r*(h-c)/s,this.scale=e,this.updateTransform(),this.setZoomRelativePoint(-1,-1)}}},{key:"doSetupChannel",value:function(e){var t,n=this,i=null==e||null===(t=e.channels)||void 0===t?void 0:t.find((function(e){return e.id===n.channel}));if(i&&i.index){var r=null==e?void 0:e.components;r&&r.filter((function(e){return e.schId&&e.channel===n.channel})).forEach((function(e){var t="",i=e.designator,r=i.indexOf(" (");r>0&&(t=i.substring(r+1),i=i.substring(0,r)),n.setChannelDesignator(e.designatorId,i,t)}))}}},{key:"setChannelDesignator",value:function(e,t,n){var i=0,r=0,o=this.svg.getElementById(e);o&&Array.from(o.children).forEach((function(e){if("text"===e.nodeName){var o=e;if(0===r){var a=o.textLength.baseVal.value;e.textContent=t,i=o.textLength.baseVal.value-a,r++}else if(1===r){e.textContent=n;var c="translate(".concat(i,",",0,")");return void e.setAttribute("transform",c)}}}))}},{key:"getSceneInfo",value:function(){var e=this.svg.getElementById("BackgroundGroup");if(e&&e.children.length>0){var t=e.children[0],n=Number.parseFloat(t.getAttribute("width")),i=Number.parseFloat(t.getAttribute("height"));if(!Number.isNaN(n)&&!Number.isNaN(i))return{width:n,height:i}}return{width:this.scene.getBBox().width,height:this.scene.getBBox().height}}}]),e}(),O=n(556);function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function j(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){x(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function A(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C,T=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),x(this,"documentContainer",void 0),x(this,"emptyDocumentRenederer",void 0),x(this,"documentRenederer",void 0),x(this,"metadata",null),x(this,"userInteractionService",void 0),x(this,"documentRenderState",void 0),x(this,"renderStates",new Map),x(this,"selectionService",void 0),x(this,"logger",void 0),x(this,"location",void 0),x(this,"debounceEmitDocumentLocation",Object(u.a)((function(){n.emitDocumentLocation()}),250)),this.emptyDocumentRenederer=S("EMPTY",(function(){return null})),this.documentRenederer=this.emptyDocumentRenederer,this.selectionService=t,this.documentRenderState=new r.a(this),this.userInteractionService=new O.a,this.userInteractionService.on("zoom",(function(e){n.documentRenederer.zoom(e.x,e.y,e.delta)})),this.userInteractionService.on("panMove",(function(e){n.documentRenederer.move(e.deltaX,e.deltaY),i.a.bus.emit("SchEngine:documentMove",{type:"move",documentId:n.documentRenederer.documentId,x:e.x,y:e.y}),n.debounceEmitDocumentLocation()})),this.userInteractionService.on("select",(function(e){i.a.bus.emit("SchEngine:documentClick",j(j({},e),{},{type:"click",documentId:n.documentRenederer.documentId})),n.selectionService.selectByPoint(e)})),i.a.bus.on("SchEngine:zoomToFit",(function(e){return n.documentRenederer.zoomToFit(e.rect,e.changeScale,e.margin)})),this.logger=i.a.createLogger("DocumentRenderService")}var t,n,o;return t=e,(n=[{key:"doAttachToWorkspace",value:function(e){var t=document.createElement("div");t.setAttribute("id","sch_document_viewer"),t.setAttribute("oncontextmenu","return false");var n=t.style;n.width="100%",n.height="100%",n.position="relative",n.overflow="hidden",this.documentContainer=e.appendChild(t),this.userInteractionService.attachToWorkspace(this.documentContainer)}},{key:"doAttachDocument",value:function(e){var t=this;try{var n;if(null!==e.errorState)throw e.errorState;var i=null==e||null===(n=e.renderData)||void 0===n?void 0:n.documentElement.cloneNode(!0);if(!i)throw this.logger.LogError("Document attach error, no data to render.\n                Load state: ".concat(e.loadState,", name: ").concat(e.name,", id: ").concat(e.id)),new Error("Document attach error, no data to render");this.documentRenederer=S("DEFAULT",(function(){return{workspace:t.documentContainer,node:i,uniqueId:e.uniqueId,channelId:e.channelId,documentId:e.id,selectionService:t.selectionService,metadata:t.metadata}})),this.documentRenederer.useAnimatedZoomToFit=!0}catch(t){this.documentRenederer=S("ERROR",(function(){return{errorState:t,documentId:e.id}}))}}},{key:"doDettachDocument",value:function(){"EMPTY"!==this.documentRenederer.type&&(this.saveState(),this.documentRenederer.destroy(),this.documentRenederer=this.emptyDocumentRenederer)}},{key:"saveState",value:function(){"DEFAULT"===this.documentRenederer.type&&this.renderStates.set(this.documentRenederer.uniqueId,this.documentRenederer.state)}},{key:"attachTo",value:function(e){this.documentRenderState.setup(e)}},{key:"attach",value:function(e){this.documentRenederer&&e.uniqueId===this.documentRenederer.uniqueId||(this.documentRenderState.dettachDocument(),this.documentRenderState.attachDocument(e))}},{key:"setLocation",value:function(e){this.location=e}},{key:"setPosition",value:function(e){var t,n=this;this.location&&null!==(t=this.location)&&void 0!==t&&t.docId&&(this.renderStates.set(this.location.docId,{zoom:this.location.zoom,top:this.location.top,left:this.location.left}),this.location=null);var i=this.renderStates.get(e.uniqueId);return setTimeout((function(){n.emitDocumentLocation()}),50),i?new Promise((function(e){n.documentRenederer.state=i,e()})):this.documentRenederer.zoomToFit(null,!0,.9)}},{key:"setMetadata",value:function(e){this.metadata=e}},{key:"render",value:function(e){return this.attach(e),this.documentRenederer.render()}},{key:"reset",value:function(){this.documentRenederer.zoomToFit(null,!0,.9),i.a.bus.emit("SchEngine:resetDocumentView",{type:"reset",documentId:this.documentRenederer.documentId})}},{key:"emitDocumentLocation",value:function(){i.a.bus.emit("SchEngine:documentLocation",j(j({},this.documentRenederer.state),{},{type:"sch"}))}}])&&A(t.prototype,n),o&&A(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}(),N=n(555);!function(e){e[e.Component=1]="Component",e[e.Net=2]="Net",e[e.Wire=3]="Wire",e[e.Port=4]="Port",e[e.SheetEntry=5]="SheetEntry",e[e.SheetSymbol=6]="SheetSymbol"}(C||(C={}));var L=n(166);function M(e){return function(e){if(Array.isArray(e))return R(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return R(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return R(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(){function e(t,n,i,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),_(this,"owner",void 0),_(this,"type",void 0),_(this,"id",void 0),_(this,"parts",void 0),_(this,"channel",void 0),_(this,"hasBounds",!1),_(this,"boundElement",null),_(this,"variantBounds",null),_(this,"ee",void 0),this.ee=window.__CORE__.createEventEmmiterInstance(),this.owner=t,this.type=n,this.id=i,this.parts=r,this.channel=o}var t,n,r;return t=e,(n=[{key:"once",value:function(e,t){return this.ee.once(e,t)}},{key:"on",value:function(e,t){return this.ee.on(e,t)}},{key:"off",value:function(e,t){return this.ee.off(e,t)}},{key:"eventNames",value:function(){return this.ee.eventNames()}},{key:"emit",value:function(e,t){return this.ee.emit(e,t)}},{key:"getRootOwner",value:function(){return this.owner?this.owner.getRootOwner():this}},{key:"test",value:function(e){return!!this.boundElement&&this.boundElement.test(e)}},{key:"updateBoundRectangles",value:function(t){var n=this;if(this.type!==C.Net){if(!this.hasBounds){var r=document.getElementById(this.id),o=new Map;this.boundElement=function t(r,o){if(r&&r.localName){var a=r.localName;if("g"===a){if(n.type===C.Component){var c=r.querySelectorAll("[data-variant-id]");if(c&&c.length>0&&c.length===r.childElementCount){c.forEach((function(e){o.set(e.dataset.variantId,L.a.getPathForGroup(e))}));var s=M(o.keys()).find((function(e){return e.includes(i.c)}));return o.get(s)}return L.a.getPathForGroup(r)}if(n.type===C.Wire)try{for(var u=[],h=0;h<r.children.length;h++){var l=t(r.children[h],null);l&&u.push(l)}return L.a.join(u)}catch(t){e.logger.LogError("Setup wire error. "+t.message)}else{if(n.type===C.Port)return L.a.getPathForGroup(r);if(n.type===C.SheetEntry)return L.a.getPathForGroup(r);if(n.type===C.SheetSymbol)return L.a.getPathForGroup(r)}}else{if("line"===a)return L.a.getPathForLine(r);if("ellipse"===a)return L.a.getPathForEllipse(r);if("polyline"===a)return L.a.getPathForPolyLine(r);if("polygon"===a)return L.a.getPathForPolygon(r);if("rect"===a)return L.a.getPathForRect(r);if("path"===a)return L.a.getPathForPath(r)}}return null}(r,o),this.variantBounds=o.size>0?o:null}t.set(this.id,this)}this.hasBounds=!0,this.parts&&this.parts.forEach((function(e){return e.updateBoundRectangles(t)}))}},{key:"updateScene",value:function(e,t,n,i){var r=this;if(this.hasBounds)if(this.parts&&0!==this.parts.length){var o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("data_id",this.id),o.setAttribute("data_type","".concat(this.type));var a=this.getRootElement(this.boundElement,n,i);a&&o.appendChild(a),this.parts.forEach((function(t){return t.updateScene(e,o,n,i)})),t.appendChild(o)}else{if(this.type===C.Net)return;var c=function(e,o){var a=r.getRootElement(e,n,i);a&&(a.setAttribute("data_id",r.id),a.setAttribute("data_type","".concat(r.type)),o&&a.setAttribute("data-variant-id","".concat(o)),t.appendChild(a))};this.variantBounds?this.variantBounds.forEach((function(e,t){return c(e,t)})):c(this.boundElement,null)}}},{key:"setBound",value:function(e){var t;this.variantBounds&&(this.boundElement=null!==(t=this.variantBounds.get(e))&&void 0!==t?t:this.boundElement)}},{key:"getRootElement",value:function(e,t,n){var i=this;if(!e)return null;var r=e.createSvgElement((function(e){e.setAttribute("class",t),e.addEventListener("mouseenter",(function(){setTimeout((function(){var e=i.getRootOwner();e.emit("highlightStart",e)}),1)})),e.addEventListener("mouseleave",(function(){setTimeout((function(){var e=i.getRootOwner();e.emit("highlightComplete",e)}),1)})),n(e)}));return r||null}}])&&z(t.prototype,n),r&&z(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();_(B,"logger",window.__CORE__.createLogger("SchActiveObject"));var F,V=n(91);function G(e){return(e?e.kind:0)>>8&255}!function(e){e[e.Wire=19]="Wire",e[e.Component=26]="Component",e[e.Pin=37]="Pin",e[e.Port=38]="Port",e[e.PowerObject=39]="PowerObject",e[e.SheetEntry=40]="SheetEntry",e[e.SheetSymbol=41]="SheetSymbol"}(F||(F={}));var H=n(187);function q(e){return function(e){if(Array.isArray(e))return U(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return U(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return U(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function U(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function W(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Y(e,t,n){return t&&Z(e.prototype,t),n&&Z(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function $(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var J=function(){function e(t,n,i){W(this,e),$(this,"schId",void 0),$(this,"channelId",void 0),$(this,"primitives",void 0),this.schId=t,this.channelId=n,this.primitives=i||[]}return Y(e,[{key:"documentId",get:function(){return Object(H.a)(this.schId,this.channelId)}}]),e}(),X=function(){function e(){W(this,e),$(this,"channels",[]),$(this,"documents",[]),$(this,"primitives",[]),$(this,"links",void 0),$(this,"v2Mode",!1)}return Y(e,[{key:"setup",value:function(t){t&&(this.channels=t.channels?t.channels:[],this.v2Mode=this.channels.every((function(e){return e.fileName})),this.documents=t.schDocuments?t.schDocuments:[],this.primitives=t.primitives?t.primitives:[],this.links=new Map(t.primitives?t.primitives.filter((function(t){return e.isNavigatedPrimitive(t)})).map((function(e){return[e.schId,e]})):[]))}},{key:"getLinks",value:function(){return q(this.links.values())}},{key:"canNavigate",value:function(e){return!!this.links.get(e)}},{key:"invoke",value:function(e,t){var n=this.getNavigationItems(e,t);this.navigateTo(n)}},{key:"getNavigationItems",value:function(e,t){var n=this.links.get(e),i=t?this.channels.find((function(e){return e.id===t})):null;if(n&&i)switch(G(n)){case F.Port:if(i.parentId){var r=this.channels.find((function(e){return e.id===i.parentId}));if(r){var o=this.findPrimitive(r.schId,F.SheetEntry,i.id,n.itemLink);if(o)return new J(r.schId,r.id,[o])}}break;case F.SheetEntry:case F.SheetSymbol:if(!Array.isArray(n.channelLinks))break;var a=this.channels.find((function(e){return n.channelLinks.find((function(t){return t===e.id}))}));if(!a){var c=this.documents.find((function(e){return e.originalFileName===n.docLink}));c&&(a=a=this.v2Mode?this.channels.find((function(e){return e.fileName===c.fileName})):this.channels.find((function(e){return e.schId===c.id})))}if(a){if(n.itemLink){var s=this.findPrimitive(a.schId,F.Port,0,n.itemLink);if(s)return new J(a.schId,a.id,[s])}return new J(a.schId,a.id,[])}}}},{key:"findPrimitive",value:function(e,t,n,i){return this.primitives.find((function(r){return r.schDocId===e&&G(r)==t&&r.itemLink===i&&(!n||r.channelLinks&&r.channelLinks.find((function(e){return e===n})))}))}},{key:"navigateTo",value:function(e){var t=this;if(e)return new Promise((function(n){var r=function(){setTimeout((function(){0==e.primitives.length?i.a.bus.emit("SchEngine:zoomToFit",{rect:null,changeScale:!0}):(i.a.bus.emit("SchEngine:clearSelection",{update:!0}),i.a.bus.emit("SchEngine:drawSelection",{items:e.primitives,fit:!0,fitZoom:.05}))}),100),i.a.bus.off("SCHView:documentChanged",r),n()}.bind(t);i.a.bus.on("SCHView:documentChanged",r),i.a.bus.emit("SCHView:showDocument",e.documentId)}))}}],[{key:"isNavigatedPrimitive",value:function(e){return!(!e||!e.channelLinks&&!e.itemLink)}}]),e}();function K(e){return function(e){if(Array.isArray(e))return Q(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return Q(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Q(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var te=function(){function e(){var t,n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(n="metadata")in(t=this)?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i}var t,n,i;return t=e,i=[{key:"instance",get:function(){return window.__SINGLETONS__.schMetadataRepository||(window.__SINGLETONS__.schMetadataRepository=new e),window.__SINGLETONS__.schMetadataRepository}}],(n=[{key:"attach",value:function(e){this.metadata=e}},{key:"rawMetadata",get:function(){return this.metadata}},{key:"allPcbComponents",get:function(){var e=this.rawMetadata.components.slice();return this.rawMetadata.components.forEach((function(t){t.otherPcb&&e.push.apply(e,K(Array.from(t.otherPcb.values())))})),e}},{key:"components",get:function(){return this.rawMetadata.components}},{key:"primitives",get:function(){return this.rawMetadata.primitives}},{key:"nets",get:function(){return this.rawMetadata.nets}}])&&ee(t.prototype,n),i&&ee(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();function ne(e){return function(e){if(Array.isArray(e))return re(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ie(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ie(e,t){if(e){if("string"==typeof e)return re(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?re(e,t):void 0}}function re(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function oe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ae(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}window.__CORE__;var ce=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ae(this,"activeObjects",new Map),ae(this,"boundsMap",new Map),ae(this,"idsMaps",new Map),ae(this,"logger",void 0),ae(this,"navigation",void 0),ae(this,"selectionEnabled",!0),ae(this,"currentState",null),this.logger=i.a.createLogger("SchEngine:selectionService"),this.navigation=new X}var t,n,r;return t=e,(n=[{key:"metadata",get:function(){return te.instance}},{key:"setup",value:function(){var e,t=this;this.activeObjects.clear();var n=new Set,r=new Map;(null!==(e=this.metadata.primitives)&&void 0!==e?e:[]).forEach((function(e,t){if(e.schDocId&&e.schId){var i="".concat(e.schDocId,"/").concat(e.schId);n.has(i)||(n.add(i),r.set(t,e))}})),this.setupPrimitives(this.metadata.components),this.setupNets(this.metadata.nets,r),this.setupNavigation(this.metadata.rawMetadata),i.a.bus.on("Variants:set",(function(e){t.currentState&&(t.currentState.activeObjects.forEach((function(t){return t.setBound(e)})),t.launchSelection(null))}))}},{key:"changeState",value:function(e){var t;this.selectionEnabled=e,null!==(t=this.currentState)&&void 0!==t&&t.activeObjectsGroup&&(this.currentState.activeObjectsGroup.style.display=e?"":"none")}},{key:"setupBounds",value:function(e){var t=this;if(e){var n=e.documentId;if(n){var i=this.idsMaps.get(n);i||(i=new Map,this.idsMaps.set(n,i));try{var r=window.document.createElement("div");window.document.body.appendChild(r);try{r.appendChild(e.node.cloneNode(!0)),this.getActiveObjects(n).forEach((function(e){t.currentState&&e.channel&&e.channel!==t.currentState.channelId||e.updateBoundRectangles(i)}))}finally{window.document.body.removeChild(r)}}catch(e){this.logger.LogWarn("Setup document error. "+e.message)}}}}},{key:"setupDocument",value:function(e){var t=this;this.currentState=null,this.boundsMap.clear();var n=e.documentId;if(n){this.selectionEnabled=!0;var i=this.idsMaps.get(e.id);i||(i=new Map,this.idsMaps.set(e.id,i));var r={documentId:n,channelId:e.channelId,svg:e.svg,scene:e.scene,svgPoint:e.svg.createSVGPoint(),activeObjects:this.getActiveObjects(n),activeObjectsGroup:document.createElementNS("http://www.w3.org/2000/svg","g"),ids:i};r.activeObjectsGroup.id=r.scene.id+"ActiveObjects";for(var o=0;o<r.scene.children.length;o++){var a=r.scene.children[o];if(a.id===r.activeObjectsGroup.id){r.scene.removeChild(a);break}}return r.activeObjects.forEach((function(e){e.channel&&e.channel!==r.channelId||(e.updateBoundRectangles(r.ids),e.updateScene(r.svg,r.activeObjectsGroup,"activeMouse",(function(n){t.boundsMap.set(n,e)})))})),this.currentState=r,r.activeObjectsGroup}}},{key:"selectByPoint",value:function(e){if(this.currentState){this.currentState.svgPoint.x=e.x,this.currentState.svgPoint.y=e.y;var t=this.currentState.scene.getScreenCTM();if(t){var n,i=this.currentState.svgPoint.matrixTransform(t.inverse()),r=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=ie(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw o}}}}(this.currentState.ids.values());try{for(r.s();!(n=r.n()).done;){var o=n.value;if(o.test(i))return void(this.navigation.canNavigate(o.id)?this.navigation.invoke(o.id,this.currentState.channelId):this.launchSelection(o.getRootOwner()))}}catch(e){r.e(e)}finally{r.f()}this.launchSelection(null)}}}},{key:"getActiveObjectsForItem",value:function(e){var t=this,n=[];return this.getActiveObjectById(e.schId,n),e.subParts&&e.subParts.forEach((function(e){return t.getActiveObjectById(e.schId,n)})),n}},{key:"canSelect",value:function(e){var t=G(e);return[F.Wire,F.Pin,F.PowerObject].includes(t)}},{key:"getActiveObjectById",value:function(e,t){if(this.currentState){var n=this.currentState.ids.get(e);if(n&&n.boundElement&&n.boundElement.selectedPath){var i={element:null,bounds:n.boundElement.selectedPath};n.type===C.Wire&&this.setupWireHighlight(document.getElementById(n.id),n,(function(e){return t.push({element:e})})),t.push(i)}}}},{key:"launchSelection",value:function(e){var t,n=this;if(this.metadata.rawMetadata&&this.currentState){var r=null;if(e)if(e.type===C.Component&&e.id){var o=this.currentState.documentId,a=this.metadata.allPcbComponents.find((function(t){return(!t.channel||!n.currentState||t.channel===n.currentState.channelId)&&(t.schId===e.id&&t.schDocId===o||!!t.subParts&&t.subParts.find((function(t){return t.schId===e.id&&t.schDocId===o})))}));a&&(r=Object(V.a)("component",a,"SchEngine"))}else if(e.type===C.Net){var c=this.metadata.nets[parseInt(e.id)];r=Object(V.a)("net",c,"SchEngine")}if(!r||this.selectionEnabled){var s=null===(t=r)||void 0===t?void 0:t.native.pcbDocId;s&&i.a.bus.emit("PcbEngine:setActiveDocument",s),i.a.bus.emit("select",r)}}}},{key:"getActiveObjects",value:function(e){if(!e)return[];var t=this.activeObjects.get(e);return t||[]}},{key:"createActiveObject",value:function(e,t,n,r){var o=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,c=new B(e,t,n,r,a);return c.on("highlightStart",(function(e){o.invokeHighlight(c)})),c.on("highlightComplete",(function(){return i.a.bus.emit("SchEngine:clearHighlight")})),c}},{key:"addActiveObject",value:function(e,t){if(e&&t){var n=this.activeObjects.get(e);n||(n=[],this.activeObjects.set(e,n)),n.push(t)}}},{key:"setupPrimitives",value:function(e){var t=this;e&&e.forEach((function(e){e.kind&&G(e)===F.Component&&t.setupComponent(e)}))}},{key:"setupNets",value:function(e,t){var n=this;e&&t&&e.forEach((function(e,i){n.setupNet(e,i,t)}))}},{key:"setupNet",value:function(e,t,n){var i=this;if(e.primitives){var r=e.primitives.map((function(e){return n.get(e)})).filter((function(e){return void 0!==e})).filter((function(e){return i.canSelect(e)}));if(r.length){var o=r.reduce((function(e,t){return e[t.schDocId]=[].concat(ne(e[t.schDocId]||[]),[t]),e}),{});Object.keys(o).forEach((function(n){var r=[],a=i.createActiveObject(null,C.Net,"".concat(t),r,e.channel);o[n]&&o[n].forEach((function(t){r.find((function(e){return e.id===t.schId}))||r.push(i.createActiveObject(a,C.Wire,t.schId,null,e.channel))})),i.addActiveObject(n,a)}))}}}},{key:"setupComponent",value:function(e){var t=this;if(e.schId&&e.schDocId)if(e.subParts){var n=new Map;n.set(e.schDocId,[e]),e.subParts.forEach((function(e){n.has(e.schDocId)?n.get(e.schDocId).push(e):n.set(e.schDocId,[e])})),n.forEach((function(n,i){if(0!==n.length){var r=[],o=t.createActiveObject(null,C.Component,n[0].schId,r,e.channel);t.addActiveObject(i,o),0!==(n=n.slice(1)).length&&n.forEach((function(n){return r.push(t.createActiveObject(o,C.Component,n.schId,null,e.channel))}))}}))}else{var i=this.createActiveObject(null,C.Component,e.schId,[],e.channel);this.addActiveObject(e.schDocId,i)}}},{key:"setupNavigation",value:function(e){var t=this;this.navigation.setup(e);var n=[];this.navigation.getLinks().forEach((function(e){var i=function(e){switch(G(e)){case F.Component:return C.Component;case F.Port:return C.Port;case F.SheetEntry:return C.SheetEntry;case F.SheetSymbol:return C.SheetSymbol;case F.Wire:return C.Wire}return 0}(e),r=t.createActiveObject(null,i,e.schId,null);i===C.SheetSymbol?n.push({docId:e.schDocId,obj:r}):t.addActiveObject(e.schDocId,r)})),n.forEach((function(e){t.addActiveObject(e.docId,e.obj)}))}},{key:"invokeHighlight",value:function(e){var t=this;this.currentState&&(e.type===C.Component?e.boundElement&&e.boundElement.selectedPath&&e.boundElement.selectedPath.forEach((function(t){var n=t.createSvgElement(3);n.setAttribute("data-id",e.id),i.a.bus.emit("SchEngine:drawHighlight",n)})):e.type===C.Wire&&this.setupWireHighlight(this.currentState.svg.getElementById(e.id),e,(function(e){return i.a.bus.emit("SchEngine:drawHighlight",e)})),e.parts&&e.parts.forEach((function(e){return t.invokeHighlight(e)})))}},{key:"setupWireHighlight",value:function(e,t,n){var i=this;if(e&&e.localName){var r=e.localName;if("g"===r)this.forEveryChild(e,(function(e){return i.setupWireHighlight(e,t,n)}));else if("line"===r||"polyline"===r||"rect"===r||"path"===r){var o=e.cloneNode(!0);o.setAttribute("data-id",t.id),o.hasAttribute("id")&&o.removeAttribute("id"),n(o)}}}},{key:"forEveryChild",value:function(e,t){for(var n=e.children,i=0;i<n.length;i++){var r=n[i];r&&t(r)}}}])&&oe(t.prototype,n),r&&oe(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),se=n(120);function ue(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function le(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */le=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},r=i.iterator||"@@iterator",o=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function s(e,t,n,i){var r=t&&t.prototype instanceof l?t:l,o=Object.create(r.prototype),a=new E(i||[]);return o._invoke=function(e,t,n){var i="suspendedStart";return function(r,o){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===r)throw o;return D()}for(n.method=r,n.arg=o;;){var a=n.delegate;if(a){var c=w(a,n);if(c){if(c===h)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===i)throw i="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i="executing";var s=u(e,t,n);if("normal"===s.type){if(i=n.done?"completed":"suspendedYield",s.arg===h)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(i="completed",n.method="throw",n.arg=s.arg)}}}(e,n,a),o}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=s;var h={};function l(){}function d(){}function f(){}var v={};c(v,r,(function(){return this}));var m=Object.getPrototypeOf,p=m&&m(m(I([])));p&&p!==t&&n.call(p,r)&&(v=p);var g=f.prototype=l.prototype=Object.create(v);function y(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var i;this._invoke=function(r,o){function a(){return new t((function(i,a){!function i(r,o,a,c){var s=u(e[r],e,o);if("throw"!==s.type){var h=s.arg,l=h.value;return l&&"object"==he(l)&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){i("next",e,a,c)}),(function(e){i("throw",e,a,c)})):t.resolve(l).then((function(e){h.value=e,a(h)}),(function(e){return i("throw",e,a,c)}))}c(s.arg)}(r,o,i,a)}))}return i=i?i.then(a,a):a()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return h;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var i=u(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var r=i.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function I(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,o=function t(){for(;++i<e.length;)if(n.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:D}}function D(){return{value:void 0,done:!0}}return d.prototype=f,c(g,"constructor",f),c(f,"constructor",d),d.displayName=c(f,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,c(e,a,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},y(b.prototype),c(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,n,i,r,o){void 0===o&&(o=Promise);var a=new b(s(t,n,i,r),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},y(g),c(g,a,"Generator"),c(g,r,(function(){return this})),c(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var i=t.pop();if(i in e)return n.value=i,n.done=!1,n}return n.done=!0,n}},e.values=I,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(n,i){return a.type="throw",a.arg=e,t.next=n,i&&(t.method="next",t.arg=void 0),!!i}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],a=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),s=n.call(o,"finallyLoc");if(c&&s){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var r=this.tryEntries[i];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;k(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),h}},e}function de(e,t,n,i,r,o,a){try{var c=e[o](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(i,r)}function fe(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var o=e.apply(t,n);function a(e){de(o,i,r,a,c,"next",e)}function c(e){de(o,i,r,a,c,"throw",e)}a(void 0)}))}}function ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function me(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),me(this,"documents",[]),me(this,"currentDocumentIndex",-1),me(this,"state",void 0),me(this,"renderService",void 0),me(this,"selectionService",void 0),me(this,"logger",void 0),me(this,"metadata",null),me(this,"shown",!1),me(this,"selectedItem",null),me(this,"selectedItemDocIds",null),me(this,"selectedItemDocIndex",-1),me(this,"showDocumentCancellationToken",null),me(this,"loadedSvgCache",new Map),this.state=new N.a(this),this.selectionService=new ce,this.renderService=new T(this.selectionService),this.logger=i.a.createLogger("SchEngine")}var t,n,r,o,a,c;return t=e,(n=[{key:"name",get:function(){return"SchEngine"}},{key:"comment",get:function(){return"SVG Schematic documents handler engine"}},{key:"dependencies",get:function(){return[]}},{key:"metaInfo",get:function(){return this}},{key:"events",get:function(){return["SchEngine:loadAllDocuments","SchEngine:didDocumentAttach","SchEngine:didDocumentDettach","SchEngine:didDocumentAttachError","SchEngine:beforeDocumentLoad","SchEngine:afterDocumentLoad","SchEngine:documentMove","SchEngine:documentZoom","SchEngine:documentClick","SchEngine:resetDocumentView","SchEngine:select","SchEngine:navigate","SchEngine:drawHighlight","SchEngine:clearHighlight","SchEngine:drawSelection","SchEngine:clearSelection","SchEngine:zoomToFit","SchEngine:didDocumentActivate","SchEngine:documentLocation"]}},{key:"activeDocumentIndex",get:function(){return this.currentDocumentIndex}},{key:"allDocuments",get:function(){return this.documents}},{key:"bus",get:function(){return i.a.bus}},{key:"setup",value:function(e){return this.state.goToSetup(e)}},{key:"showView",value:function(e){var t=this;return new Promise((function(n,i){t.state.goToAttach(e).then((function(e){return t.state.goToShow()})).then((function(e){return n()})).catch((function(e){return i(e)}))}))}},{key:"showDocument",value:(c=fe(le().mark((function e(t){var n,r,o=this;return le().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.logger.LogDebug("Show for id: "+t),i.a.bus.on("ParentConnection:setDocumentLocationSCH",(function(e){o.renderService.setLocation(e)})),n={cancelled:!1},this.showDocumentCancellationToken&&(this.showDocumentCancellationToken.cancelled=!0),this.showDocumentCancellationToken=n,e.prev=5,e.next=8,this.setActiveDocumentById(t);case 8:if(r=e.sent,!n.cancelled){e.next=11;break}return e.abrupt("return");case 11:if(this.renderService.attach(r),!this.shown){e.next=25;break}if(!n.cancelled){e.next=15;break}return e.abrupt("return");case 15:return e.next=17,this.renderService.setPosition(r);case 17:if(!n.cancelled){e.next=19;break}return e.abrupt("return");case 19:return e.next=21,this.renderService.render(r);case 21:if(!n.cancelled){e.next=23;break}return e.abrupt("return");case 23:return e.next=25,this.doSelectItem();case 25:e.next=30;break;case 27:return e.prev=27,e.t0=e.catch(5),e.abrupt("return",Promise.reject(e.t0));case 30:case"end":return e.stop()}}),e,this,[[5,27]])}))),function(e){return c.apply(this,arguments)})},{key:"hideView",value:function(){this.state.goToClose()}},{key:"resetView",value:function(){this.renderService.reset()}},{key:"enableSelection",value:function(e){this.selectionService.changeState(e)}},{key:"doSetup",value:function(e){var t=this;this.logger.LogDebug("To SETUP state");var n=e.response;if(!n)throw new Error("Response is empty");te.instance.attach(n.metadata);var i=this.getDocumentsFromStorage(n.storage);if(n&&n.metadata){this.metadata=n.metadata,this.renderService.setMetadata(n.metadata);var r=n.metadata.channels,o=n.metadata.schDocuments?n.metadata.schDocuments:[];r?this.setupChannels(i,o,r,n.storage):this.setupDocuments(i,o),this.selectionService.setup()}i.forEach((function(e){t.logger.LogError("Could nou found metadata info for document [".concat(e.name,"].")),e.order=t.documents.length,t.documents.push(e),t.documents.push(e)})),this.bus.once("SchEngine:loadAllDocuments",(function(e){return t.loadAllDocuments(e)}))}},{key:"doAttachToWorkspace",value:function(e){this.logger.LogDebug("To ATTACH_TO_WORKSPACE state"),e.setAttribute("data-view-id","schSvgView"),this.renderService.attachTo(e)}},{key:"doShow",value:function(){var e=this;return new Promise((function(t,n){if(e.logger.LogDebug("To SHOW state"),e.shown=!0,0!==e.allDocuments.length){if(e.selectedItem){var i=-1===e.currentDocumentIndex?0:e.currentDocumentIndex,r=e.documents[i].uniqueId;e.selectedItemDocIds&&e.selectedItemDocIds.find((function(e){return e===r}))?e.selectedItemDocIndex=i:e.currentDocumentIndex=e.selectedItemDocIndex}var o=-1===e.currentDocumentIndex?0:e.currentDocumentIndex;e.showDocument(e.documents[o].uniqueId).then((function(e){return t()})).catch((function(e){return n(e)}))}else e.logger.LogWarn("Any document to show")}))}},{key:"doClose",value:function(){var e;this.logger.LogDebug("To CLOSE state"),null===(e=this.renderService)||void 0===e||e.saveState(),this.shown=!1}},{key:"definePreviewUrlProperty",value:function(e,t,n){Object.defineProperty(e,"previewUrl",{get:function(){var e,i;return null!==(e=null===(i=t.files.find((function(e){return"Preview"===e.fileType&&e.originalName===n})))||void 0===i?void 0:i.dataFileUrl)&&void 0!==e?e:""}})}},{key:"getDocumentsFromStorage",value:function(e){var t,n=this;return(null!==(t=null==e?void 0:e.files.filter((function(e){return"SchSvg"===e.fileType})))&&void 0!==t?t:[]).map((function(t,r){var o=e.files.filter((function(e){return"PartMetadata"===e.fileType&&e.originalName===t.originalName})).map((function(e){return{fileType:e.fileType,fileName:e.originalName}})),a={};return a.order=r,a.id=r.toString(),a.uniqueId=r.toString(),a.channelId=0,a.loadState=i.b.IDLE,a.name=t.originalName,a.displayName=t.originalName,a.renderData=null,a.errorState=null,a.fileData={fileType:t.fileType,fileName:t.originalName},a.metadataFilesData=o,a.toString=function(){return"[".concat(a.id,"] ").concat(a.name," [").concat(a.loadState,"]")},n.definePreviewUrlProperty(a,e,a.fileData.fileName),a}))}},{key:"createBrokenDocument",value:function(e,t,n,r,o,a){this.logger.LogError("Cannot find data file for: [".concat(o,":").concat(t,"]."));var c={};return c.order=e,c.id=t,c.uniqueId=n,c.channelId=r,c.previewUrl="./images/warning.svg",c.loadState=i.b.IDLE,c.name=o,c.displayName=a,c.renderData=null,c.errorState=new Error("Cannot find document"),c}},{key:"getDataDocument",value:function(e,t){var n,i=e.findIndex((function(e){return e.name==t}));return i>=0&&(n=e[i],e.splice(i,1)),n}},{key:"setupDocuments",value:function(e,t){var n=this;t.forEach((function(t,i){if("object"===he(t)&&null!==t){var r,o=n.getDataDocument(e,t.fileName);o?(r=o,o.id=t.id,o.uniqueId=t.id,o.order=i,o.displayName=t.originalFileName||o.displayName):r=n.createBrokenDocument(i,t.id,t.id,0,t.originalFileName,t.originalFileName),n.documents.push(r)}}))}},{key:"setupChannels",value:function(e,t,n,i){var r=this,o=n.reduce((function(e,t){var n=e.get(t.schId);return n||(n=[],e.set(t.schId,n)),n.push(t),e}),new Map);Array.from(o.keys()).forEach((function(n){var a=t.find((function(e){return e.id==n}));if("object"===he(a)&&null!==a){var c=o.get(n);if(!c)return;var s=r.getDataDocument(e,a.fileName);c.forEach((function(e,t){var n;if(s)(n=Object.assign({},s)).id=a.id,n.channelId=e.id,n.uniqueId=Object(H.a)(a.id,e.id),n.order=t,n.displayName=r.formatChannelName(a.originalFileName||s.displayName,e.name),r.definePreviewUrlProperty(n,i,n.fileData.fileName);else{var o=r.formatChannelName(a.originalFileName,e.name);n=r.createBrokenDocument(t,a.id,Object(H.a)(a.id,e.id),e.id,a.originalFileName,o)}r.documents.push(n)}))}}))}},{key:"formatChannelName",value:function(e,t){var n=e;return e.split(".").length>1&&(n=e.split(".").slice(0,-1).join(".")),"".concat(n,"(").concat(t,")")}},{key:"setActiveDocumentById",value:function(e){var t=this;return new Promise((function(n,r){if(e){var o=t.getDocumentIndex(e);if(o<0||o>=t.documents.length)r("Document index is out of range.");else{var a=t.documents[o];switch(t.currentDocumentIndex=o,a.loadState){case i.b.IDLE:i.a.bus.emit("SchEngine:beforeDocumentLoad",a),a.loadState=i.b.LOAD,t.loadDocument(a).then((function(t){i.a.bus.emit("SchEngine:afterDocumentLoad",a),i.a.bus.emit("SchEngine:didDocumentActivate",e),n(a)})).catch((function(e){return r(e)}));break;case i.b.LOAD:i.a.bus.emit("SchEngine:beforeDocumentLoad",a),i.a.bus.on("SchEngine:afterDocumentLoad",(function(e){e==a&&n(a)}));break;default:i.a.bus.emit("SchEngine:didDocumentActivate",e),n(a)}}}else r("Document id is undefined.")}))}},{key:"loadAllDocuments",value:(a=fe(le().mark((function e(t){var n,r,o,a,c=this;return le().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(se.a)(100);case 2:for(t=null!==(n=t)&&void 0!==n?n:this.documents.length,r=this.documents.filter((function(e,t){return c.documents.findIndex((function(t){return t.id===e.id}))===t})),o=0;o<r.length&&o<t;o++)(a=r[o])&&a.loadState===i.b.IDLE&&(a.loadState=i.b.LOAD,this.loadDocument(a));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"loadDocument",value:(o=fe(le().mark((function e(t){var n,r,o,a,c,s,u,h,l,d,f,v,m,p,g,y,b,w=this;return le().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.a.response.storage,r=function(e){return w.documents.filter((function(t){return t.loadState!==i.b.READY&&t.fileData&&t.fileData.fileName===e})).length},!t.errorState){e.next=5;break}return t.loadState=i.b.READY,e.abrupt("return");case 5:if(e.prev=5,a=t.fileData,c=a.fileName,s=a.fileType,h=!1,!this.loadedSvgCache.has(c)){e.next=16;break}if(l=this.loadedSvgCache.get(c),r(c)||this.loadedSvgCache.delete(c),l){e.next=13;break}throw new Error("Cached reneder data is an empty");case 13:u=l,e.next=38;break;case 16:return e.next=18,n.documentLoader.loadDocument(c,s);case 18:if(d=e.sent,f=r(c),!d.bodyUsed){e.next=28;break}if(v=this.loadedSvgCache.get(c),f||this.loadedSvgCache.delete(c),v){e.next=25;break}throw new Error("Cached reneder data is an empty");case 25:u=v,e.next=38;break;case 28:return e.next=30,d.text();case 30:if(m=e.sent,u=(new DOMParser).parseFromString(m,"text/xml"),!(p=u.querySelector("parsererror"))){e.next=36;break}throw this.logger.LogError("Could not parse svg document: ".concat(p.textContent)),new Error("Could not parse svg document");case 36:h=!0,f&&this.loadedSvgCache.set(c,u);case 38:if(t.renderData=u,g=null===(o=u)||void 0===o?void 0:o.documentElement){e.next=42;break}throw new Error("Document is empty.");case 42:g.hasAttribute("data-doc-id")&&(y=g.getAttribute("data-doc-id"),t.id&&y!==t.id&&this.logger.LogError("Document meta id [".concat(t.id,"] is not equals id [").concat(y,"]"))),h&&(b={documentId:t.id,node:t.renderData.documentElement.cloneNode(!0)},this.selectionService.setupBounds(b),b.node=null),t.loadState=i.b.READY,e.next=51;break;case 47:e.prev=47,e.t0=e.catch(5),t.loadState=i.b.READY,t.errorState=t.errorState||e.t0;case 51:case"end":return e.stop()}}),e,this,[[5,47]])}))),function(e){return o.apply(this,arguments)})},{key:"onSelect",value:function(e){var t=this;return new Promise((function(n,i){var r;if(null!=(null===(r=e)||void 0===r?void 0:r.isPrimitiveContainer)&&null!=e.isPrimitiveContainer&&!1===e.isPrimitiveContainer&&(e=null),t.selectedItem=null,t.selectedItemDocIds=null,t.selectedItemDocIndex=-1,e){var o=e.native,a=t.getItemDocumentIds(o);if(0===a.length)return void t.doSelectItem();var c=e;c&&((c=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ue(Object(n),!0).forEach((function(t){me(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ue(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},c)).fit=!0,c.openedDocIds={}),t.selectedItem=c,t.selectedItemDocIds=a;var s=o.documentId;if(s||(!(s=t.activeDocumentIndex>-1?t.documents[t.activeDocumentIndex].uniqueId:null)||a.indexOf(s)<0)&&(s=a[0]),!s)return;t.shown&&"SchEngine"===e.senderId&&(c.openedDocIds[s]=!0);var u=t.getDocumentIndex(s);t.selectedItemDocIndex=u,t.shown&&t.currentDocumentIndex===u?t.doSelectItem().catch((function(e){i(e)})):t.shown&&t.currentDocumentIndex!==u?t.showDocument(s).catch((function(e){i(e)})):t.setActiveDocumentById(s).catch((function(e){i(e)}))}else t.doSelectItem().catch((function(e){i(e)}))}))}},{key:"getItemDocumentIds",value:function(e){var t=this,n=[];if(!e)return n;if(e.schDocId){var i=e.channel;if(!i&&this.activeDocumentIndex>-1){var r=this.documents[this.activeDocumentIndex];e.schDocId===r.id&&(i=r.channelId)}var o=Object(H.a)(e.schDocId,i);n.push(o),e.subParts&&e.subParts.forEach((function(e){var i=e.schDocId;!i||n.indexOf(i)>=0||t.documents.filter((function(e){return e.id===i})).forEach((function(e){n.push(e.uniqueId)}))}))}else if(e.primitives){var a=this.metadata.primitives;e.primitives.forEach((function(e){var i=a[e];if(i){var r=i.schDocId;!r||n.indexOf(r)>=0||t.documents.filter((function(e){return e.id===r})).forEach((function(e){n.push(e.uniqueId)}))}}))}return n.filter((function(e,t,n){return n.indexOf(e)===t}))}},{key:"doSelectItem",value:function(){var e=this;return new Promise((function(t){setTimeout((function(){if(i.a.bus.emit("SchEngine:clearHighlight"),e.selectedItem){var n=e.selectedItem,r=[];"component"===n.name?r.push(n.native):"net"===n.name?n.native.primitives&&(r=n.native.primitives.map((function(t){return e.metadata.primitives[t]})).filter((function(t){return e.selectionService.canSelect(t)}))):i.a.bus.emit("SchEngine:clearSelection",{update:!1}),r.length>0&&(i.a.bus.emit("SchEngine:clearSelection",{update:!0}),setTimeout((function(){var t=e.documents[e.currentDocumentIndex].uniqueId;i.a.bus.emit("SchEngine:drawSelection",{items:r,fit:n.fit&&!n.openedDocIds[t]}),n.openedDocIds[t]=!0}),0))}else i.a.bus.emit("SchEngine:clearSelection",{update:!1});t()}),0)}))}},{key:"getDocumentIndex",value:function(e){var t=this.documents.findIndex((function(t){return t.uniqueId===e}));return-1==t&&(t=this.documents.findIndex((function(t){return t.id===e}))),t}}])&&ve(t.prototype,n),r&&ve(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ge={type:"Engine",name:"SchEngineModule",description:"Presents schematic documents engine module",create:function(){return new pe}};window.__CORE__&&window.__CORE__.addModule(ge)}});