!function(e){function t(t){for(var r,a,c=t[0],u=t[1],s=t[2],f=0,d=[];f<c.length;f++)a=c[f],Object.prototype.hasOwnProperty.call(i,a)&&i[a]&&d.push(i[a][0]),i[a]=0;for(r in u)Object.prototype.hasOwnProperty.call(u,r)&&(e[r]=u[r]);for(l&&l(t);d.length;)d.shift()();return o.push.apply(o,s||[]),n()}function n(){for(var e,t=0;t<o.length;t++){for(var n=o[t],r=!0,c=1;c<n.length;c++){var u=n[c];0!==i[u]&&(r=!1)}r&&(o.splice(t--,1),e=a(a.s=n[0]))}return e}var r={},i={66:0},o=[];function a(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=r,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="";var c=window.webpackJsonp=window.webpackJsonp||[],u=c.push.bind(c);c.push=t,c=c.slice();for(var s=0;s<c.length;s++)t(c[s]);var l=u;o.push([1259,2]),n()}({1259:function(e,t,n){e.exports=n(1287)},1287:function(e,t,n){"use strict";n.r(t);var r=n(19),i=n(545),o=n(18),a=n(44);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */u=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function s(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var i=t&&t.prototype instanceof h?t:h,o=Object.create(i.prototype),a=new O(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return D()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var c=k(a,n);if(c){if(c===d)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=f(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===d)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,a),o}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var d={};function h(){}function p(){}function y(){}var v={};s(v,i,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(E([])));g&&g!==t&&n.call(g,i)&&(v=g);var b=y.prototype=h.prototype=Object.create(v);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function L(e,t){var r;this._invoke=function(i,o){function a(){return new t((function(r,a){!function r(i,o,a,u){var s=f(e[i],e,o);if("throw"!==s.type){var l=s.arg,d=l.value;return d&&"object"==c(d)&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,a,u)}),(function(e){r("throw",e,a,u)})):t.resolve(d).then((function(e){l.value=e,a(l)}),(function(e){return r("throw",e,a,u)}))}u(s.arg)}(i,o,r,a)}))}return r=r?r.then(a,a):a()}}function k(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var r=f(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,d;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function E(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:D}}function D(){return{value:void 0,done:!0}}return p.prototype=y,s(b,"constructor",y),s(y,"constructor",p),p.displayName=s(y,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,s(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(L.prototype),s(L.prototype,o,(function(){return this})),e.AsyncIterator=L,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new L(l(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},w(b),s(b,a,"Generator"),s(b,i,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=E,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(P),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,d):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;P(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:E(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},e}function s(e,t,n,r,i,o,a){try{var c=e[o](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){s(o,r,i,a,c,"next",e)}function c(e){s(o,r,i,a,c,"throw",e)}a(void 0)}))}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t){return(d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=v(e);if(t){var i=v(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return y(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e){return(v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g={where:function(e){return["Load"===e.type]},to:"LOAD"},b={where:function(e){return["Show"===e.type]},to:"SHOW"},w={where:function(e){return["Error"===e.type]},to:"CRASHED",error:!0},L={IDLE:[{where:function(e){return["Setup"===e.type]},to:"SETUP"}],SETUP:[{where:function(e){return["SetupComplete"===e.type]},to:"SETUP_COMPLETED"},w],SETUP_COMPLETED:[{where:function(e){return["Init"===e.type]},to:"INIT"},w],INIT:[{where:function(e){return["InitComplete"===e.type]},to:"INIT_COMPLETED"},w],INIT_COMPLETED:[g,w],LOAD:[{where:function(e){return["LoadComplete"===e.type]},to:"LOAD_COMPLETED"},w],LOAD_COMPLETED:[{where:function(e){return["Render"===e.type]},to:"RENDER"},w],RENDER:[{where:function(e){return["RenderComplete"===e.type]},to:"RENDER_COMPLETED"},w],RENDER_COMPLETED:[b,w],SHOW:[b,g,w]},k=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(s,e);var t,n,r,i,o,c=h(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),m(y(t=c.call(this,"IDLE",L)),"engine",void 0),m(y(t),"errorState",null),t.engine=e,t.onSetup=t.onSetup.bind(y(t)),t.onInit=t.onInit.bind(y(t)),t.onLoad=t.onLoad.bind(y(t)),t.onRender=t.onRender.bind(y(t)),t.onShow=t.onShow.bind(y(t)),t.on("SETUP",t.onSetup),t.on("INIT",t.onInit),t.on("LOAD",t.onLoad),t.on("RENDER",t.onRender),t.on("SHOW",t.onShow),t}return t=s,(n=[{key:"goToSetup",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Setup",core:e})||"SETUP"===t.state?(t.once("SETUP_COMPLETED",(function(){n()})),t.once("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToInit",value:function(){var e=this;return new Promise((function(t,n){e.dispatch({type:"Init"})||"INIT"===e.state?(e.once("INIT_COMPLETED",(function(){t()})),e.once("CRASHED",(function(t){e.errorState=t,n(e.errorState)}))):"CRASHED"===e.state?n(e.errorState):t()}))}},{key:"goToLoad",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Load",document:e})?(window.__CORE__.bus.emit("PcbEngine:beforeDocumentLoad",e),t.once("LOAD_COMPLETED",(function(){window.__CORE__.bus.emit("PcbEngine:afterDocumentLoad"),n()})),t.once("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToRender",value:function(e){var t=this;return new Promise((function(n,r){t.dispatch({type:"Render",document:e})||"RENDER"===t.state?(window.__CORE__.bus.emit("PcbEngine:beforeImportPCB",e),t.once("RENDER_COMPLETED",(function(){window.__CORE__.bus.emit("PcbEngine:afterImportPCB",e),n()})),t.once("CRASHED",(function(e){t.errorState=e,r(t.errorState)}))):"CRASHED"===t.state?r(t.errorState):n()}))}},{key:"goToShow",value:function(e,t){var n=this;return new Promise((function(r,i){n.dispatch({type:"Show",workspace:e,renderMode:t})||"SHOW"===n.state?r():i("Cannot show. Wrong state [".concat(n.state,"]"))}))}},{key:"nextTick",value:function(e){setTimeout((function(){e()}))}},{key:"onSetup",value:function(e){var t=this;try{var n=e.core;this.engine.doSetup(n),this.nextTick((function(){return t.dispatch({type:"SetupComplete"})}))}catch(e){this.nextTick((function(){return t.dispatch(new a.a(e.message,e))}))}}},{key:"onInit",value:(o=l(u().mark((function e(){var t=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.engine.doInit();case 3:this.dispatch({type:"InitComplete"}),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),this.nextTick((function(){return t.dispatch(new a.a(e.t0.message,e.t0))}));case 9:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(){return o.apply(this,arguments)})},{key:"onLoad",value:(i=l(u().mark((function e(t){var n=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.engine.doLoad(t.document);case 3:this.dispatch({type:"LoadComplete"}),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),this.nextTick((function(){return n.dispatch(new a.a(e.t0.message,e.t0))}));case 9:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(e){return i.apply(this,arguments)})},{key:"onRender",value:function(e){var t=this;try{this.engine.doRender(e.document),this.nextTick((function(){return t.dispatch({type:"RenderComplete"})}))}catch(e){this.nextTick((function(){return t.dispatch(new a.a(e.message,e))}))}}},{key:"onShow",value:function(e){this.engine.doShow(e.workspace,e.renderMode)}}])&&f(t.prototype,n),r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),s}(o.a),S=n(222),P=n(34);function O(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,o=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){c=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw i}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return E(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return E(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function D(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var M=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),x(this,"scene",void 0),x(this,"materialId",void 0),x(this,"logger",void 0),x(this,"renderMode",void 0),this.scene=t,this.materialId=i,this.renderMode=n,this.logger=r.a.createLogger("PadAppearance_"+n)}var t,n,i;return t=e,(n=[{key:"set",value:function(e,t){try{var n=this.scene.getBoundingBoxForItem(e),r=this.getSizeAndPosition(n),i=P.a.createRectangle(r.x,r.y,r.radius,r.radius,this.materialId,[1,0],r.radius/2,r.z);return this.scene.addItem(t,[i],[],[],[],[],[])}catch(e){return this.logger.LogError("Set mark.",e),null}}},{key:"getSizeAndPosition",value:function(e){var t=O(e,6),n=t[0],r=t[1],i=t[2],o=t[3],a=t[4];return{x:n+(o-n)/2,y:r+(a-r)/2,z:[i-.005,t[5]+.005],radius:.4*Math.min(o-n,a-r)}}}])&&D(t.prototype,n),i&&D(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),I=n(39),N=n(51),j=n(221);function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function C(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return A(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw o}}}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function T(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */T=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof f?t:f,o=Object.create(i.prototype),a=new S(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return O()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var c=w(a,n);if(c){if(c===l)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=s(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,a),o}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function f(){}function d(){}function h(){}var p={};c(p,i,(function(){return this}));var y=Object.getPrototypeOf,v=y&&y(y(P([])));v&&v!==t&&n.call(v,i)&&(p=v);var m=h.prototype=f.prototype=Object.create(p);function g(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var r;this._invoke=function(i,o){function a(){return new t((function(r,a){!function r(i,o,a,c){var u=s(e[i],e,o);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==R(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,a,c)}),(function(e){r("throw",e,a,c)})):t.resolve(f).then((function(e){l.value=e,a(l)}),(function(e){return r("throw",e,a,c)}))}c(u.arg)}(i,o,r,a)}))}return r=r?r.then(a,a):a()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=s(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function P(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:O}}function O(){return{value:void 0,done:!0}}return d.prototype=h,c(m,"constructor",h),c(h,"constructor",d),d.displayName=c(h,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,c(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},g(b.prototype),c(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new b(u(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(m),c(m,a,"Generator"),c(m,i,(function(){return this})),c(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;k(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:P(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}function _(e,t,n,r,i,o,a){try{var c=e[o](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,i)}function V(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var G=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),B(this,"scene",void 0),B(this,"padAppearance",void 0),B(this,"logger",void 0),B(this,"pinPadMap",new Map),this.padAppearance=t,this.scene=n,this.logger=r.a.createLogger("ComponentPadAppearance")}var t,n,i,o,a;return t=e,(n=[{key:"setAppearancePadComponents",value:function(e,t){var n=this;if(this.scene){var r=new Map,i=new Map,o=new Map;try{var a=e.getLayers(),c=e.getLayers().filter((function(e){return"Pad Holes"===e.searchName||"Via Holes"===e.searchName})).map((function(e){return e.id}));t.forEach((function(e){var t,n=null===(t=j.a.instance.getChildPads(e))||void 0===t?void 0:t.find((function(e){return"1"===e.name}));n&&n.pcbId&&(r.set(n.pcbId,e),i.set(n.pcbId,n),o.has(e.layerId)||o.set(e.layerId,a.find((function(t){return t.metaId===e.layerId}))))}));var u=this.scene.getNodeItemsByIds(Array.from(r.keys()));if(!u)return;u.forEach((function(e){if(e){var t=e.GetId(),a=r.get(t),u=i.get(t);if(a&&u)try{var s,l=o.get(a.layerId);if(!l)return;var f=null!==(s=n.isSpecialHoleLayer(e,c))&&void 0!==s?s:l.id,d=n.padAppearance.set(e,f);if(!d)return;var h=d.GetId();u.customNodes||(u.customNodes=[]),u.customNodes.push(h),n.pinPadMap.set(h,u)}catch(e){n.logger.LogError("Failed set pad appearance for component ".concat(a.designator,"."),e)}}}))}finally{r.clear(),i.clear(),o.clear()}}}},{key:"setVisibleAppearances",value:(o=T().mark((function e(t){var n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=Array.from(this.pinPadMap.keys())).length){e.next=3;break}return e.abrupt("return");case 3:try{this.scene.setNodeItemsVisibility(n,t)}catch(e){this.logger.LogError("Set Visible = ".concat(t," for appearances."),e)}case 4:case"end":return e.stop()}}),e,this)})),a=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=o.apply(e,t);function a(e){_(i,n,r,a,c,"next",e)}function c(e){_(i,n,r,a,c,"throw",e)}a(void 0)}))},function(e){return a.apply(this,arguments)})},{key:"clearAppearance",value:function(){var e=Array.from(this.pinPadMap.keys()),t=this.scene.getNodeItemsByIds(e);if(t){var n,r=C(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;try{var o=i.GetId(),a=this.pinPadMap.get(o);if(a&&a.customNodes){var c=a.customNodes.indexOf(o);c>=0&&a.customNodes.splice(c,1)}this.scene.deleteItem(i)}catch(e){this.logger.LogError("Failed to remove nodeItem for Pad appearance",e)}}}catch(e){r.e(e)}finally{r.f()}}this.pinPadMap.clear()}},{key:"setVisibleComponents",value:function(e,t){try{var n=j.a.instance;e||(e=j.a.instance.components);var r=e.flatMap((function(e){return n.getChildPrimitives(e)})).filter((function(e){return n.getObjectId(e)!==I.a.Pad})).filter((function(e){return e&&e.pcbId})).map((function(e){return e.pcbId}));try{this.scene.setNodeItemsVisibility(r,t)}catch(e){this.logger.LogError("Set nodes visibility",e)}}catch(e){this.logger.LogError("Failed to remove nodeItem for Pad appearance.",e)}}},{key:"isSpecialHoleLayer",value:function(e,t){if(e&&this.padAppearance.renderMode===N.b.Render2D)for(var n=0;n<e.GetLayersCount();n++){var r=e.GetLayerGeometry(n).GetLayerIndex();if(t.indexOf(r)>=0)return r}return null}}])&&V(t.prototype,n),i&&V(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),F=n(105),U=n(78);function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var W=[0,0,0,230],z=[0,0,0,230],Z=function(){function e(t,n,i){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),K(this,"componentPadAppearance2d",void 0),K(this,"componentPadAppearance3d",void 0),K(this,"logger",void 0),this.logger=r.a.createLogger("PadAppearanceManager"),i==N.b.Render3D?(this.componentPadAppearance2d=this.createAppearance(t,W,N.b.Render2D),this.componentPadAppearance3d=this.createAppearance(n,z,N.b.Render3D)):(this.componentPadAppearance3d=this.createAppearance(n,z,N.b.Render3D),this.componentPadAppearance2d=this.createAppearance(t,W,N.b.Render2D)),r.a.bus.on("PcbEngine:changedRenderMode",(function(e){return o.setRenderMode(e)}))}var t,n,i;return t=e,(n=[{key:"setPadAppearance",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n||(n=j.a.instance.components);try{this.componentPadAppearance2d.setAppearancePadComponents(e,n),this.componentPadAppearance3d.setAppearancePadComponents(e,n),this.setRenderMode(t)}catch(e){this.logger.LogError("Failed set pad appearance for components",e)}}},{key:"clearPadAppearance",value:function(){this.componentPadAppearance2d.clearAppearance(),this.componentPadAppearance3d.clearAppearance()}},{key:"setRenderMode",value:function(e){e==N.b.Render2D?(this.componentPadAppearance3d.setVisibleAppearances(!1),this.componentPadAppearance2d.setVisibleAppearances(!0)):(this.componentPadAppearance2d.setVisibleAppearances(!1),this.componentPadAppearance3d.setVisibleAppearances(!0))}},{key:"createAppearance",value:function(e,t,n){var r=e.addMaterial(new U.a(new Uint8Array(t),F.b.None,!1)),i=new M(e,n,r);return new G(i,e)}}])&&H(t.prototype,n),i&&H(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Y=n(387),Q=n(102),X=n(101),$=n(21);function q(e){return function(e){if(Array.isArray(e))return J(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return J(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return J(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function J(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ee(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function te(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ne=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),te(this,"layerManager",void 0),te(this,"layers",[]),te(this,"lastOnceLayer",null),te(this,"currentLayerState",null),this.layerManager=t}var t,n,r;return t=e,(n=[{key:"setOnceLayer",value:function(e){var t;if("string"==typeof e){if(!(t=this.layers.find((function(t){return t.name===e}))))return;this.currentLayerState||(this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})))}else t=e;if(t){this.lastOnceLayer=t;var n=this.lastOnceLayer.name;this.layers.forEach((function(e){var t=e.name==n;e.isVisible=t||e.name==$.b.BoardShape||e.name==$.b.BackgroundLayer||e.name==$.b.Background,e.isActive=t})),this.updateLayersVisibility()}}},{key:"nextOnceLayer",value:function(){var e,t=this.getSortedLayers();if(this.lastOnceLayer&&this.currentLayerState){var n=this.lastOnceLayer.name,r=t.findIndex((function(e){return e.name==n}));r==t.length-1&&(r=-1),e=t.find((function(e,t){return!e.ignored&&t>r}))}else this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})),e=t.find((function(e){return e.isVisible&&!e.ignored}));return e&&this.setOnceLayer(e),e}},{key:"prevOnceLayer",value:function(){var e,t=this.getSortedLayers().reverse();if(this.lastOnceLayer&&this.currentLayerState){var n=t.indexOf(this.lastOnceLayer);n==t.length-1&&(n=-1),e=t.find((function(e,t){return!e.ignored&&t>n}))}else this.currentLayerState=this.layers.map((function(e){return Object.assign({},e)})),e=t.find((function(e){return e.isVisible&&!e.ignored}));return e&&this.setOnceLayer(e),e}},{key:"resetOnceLayer",value:function(){this.lastOnceLayer=null,this.currentLayerState&&(this.layers=this.currentLayerState,this.updateLayersVisibility(),this.currentLayerState=null)}},{key:"updateLayersVisibility",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.layerManager.setLayers(this.layers,e)}},{key:"getSortedLayers",value:function(){var e=[];return this.layerManager.getGroupedLayers().forEach((function(t){return e.push.apply(e,q(t))})),e}}])&&ee(t.prototype,n),r&&ee(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function re(e){return function(e){if(Array.isArray(e))return ie(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return ie(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ie(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function oe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ae(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oe(Object(n),!0).forEach((function(t){ue(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ce(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ue(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var se,le,fe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ue(this,"scene",void 0),ue(this,"onceLayerManager",void 0),ue(this,"holeConnecterLayerKins",[$.a.Signal,$.a.Solder,$.a.Plane]),this.scene=t,this.onceLayerManager=new ne(this)}var t,n,i;return t=e,(n=[{key:"flipped",get:function(){return this.scene.flipped}},{key:"viewType",get:function(){return this.flipped?"bottom":"top"}},{key:"layers",get:function(){return this.onceLayerManager.layers},set:function(e){this.onceLayerManager.layers=e}},{key:"setLayers",value:function(e,t){this.scene.renderOptions=this.createRenderOptions(this.scene.layers,t,e),this.layers=e,this.emitLayerEvent("setLayer",e,!1)}},{key:"resetLayers",value:function(){this.layers=this.getLayers(!1),this.setLayers(this.layers,!1),this.emitLayerEvent("resetLayer",this.layers,!1)}},{key:"recoveryLayers",value:function(e){if(e){var t=this.getLayers(!1);this.setLayers(t.map((function(t){return ae(ae({},t),{},{isActive:t.metaId===(null==e?void 0:e.active),isVisible:null==e?void 0:e.visible.includes(t.metaId)})})),!1)}}},{key:"getGroupedLayers",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=function(e){return"Copper"==e?1:"Solder Mask"==e?2:"Paste Mask"==e?3:"Silkscreen"==e?4:"Mechanical"==e?5:"Other"==e?6:0},n=[],r=this.getLayers(e),i=re(new Set(r.map((function(e){return e.layerGroup})))).sort();return i.filter((function(e){return"none"!==e&&"System Colors"!==e})).sort((function(e,n){return t(e)-t(n)})).forEach((function(e){var t=r.filter((function(t){return!t.ignored&&t.layerGroup===e}));"Mechanical"===e&&(t=t.map((function(e){return{layer:e,stackIndex:e.stackIndex?e.stackIndex:1e3}})).sort((function(e,t){return e.stackIndex-t.stackIndex})).map((function(e){return e.layer}))),t.length>0&&n.push(t)})),n}},{key:"setTopView",value:function(){this.flipped&&(this.flipBoard(),this.emitLayerEvent("setTopView",this.layers,!1))}},{key:"setBottomView",value:function(){this.flipped||(this.flipBoard(),this.emitLayerEvent("setBottomView",this.layers,!1))}},{key:"setOnceLayer",value:function(e){this.onceLayerManager.setOnceLayer(e),this.emitLayerEvent("setOnceLayer",e)}},{key:"nextOnceLayer",value:function(){var e=this.onceLayerManager.nextOnceLayer();return this.emitLayerEvent("setOnceLayer",e),e}},{key:"prevOnceLayer",value:function(){var e=this.onceLayerManager.prevOnceLayer();return this.emitLayerEvent("setOnceLayer",e),e}},{key:"resetOnceLayer",value:function(){this.onceLayerManager.resetOnceLayer(),this.emitLayerEvent("resetOnceLayer",null,!1)}},{key:"emitLayerEvent",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i="LayerManager:changedLayers",o={eventType:e,data:t,needLayersChange:n};r.a.bus.emit(i,o)}},{key:"defineLayerGroup",value:function(e,t){return 0!=(e&$.a.Signal)||0!=(e&$.a.Plane)?"Copper":0!=(e&$.a.Paste)?"Paste Mask":0!=(e&$.a.Overlay)?"Silkscreen":0!=(e&$.a.Solder)?"Solder Mask":0!=(e&$.a.Mechanical)?"Mechanical":0!=(e&$.a.Other)?"Other":0!=(e&$.a.System)?"System Colors":0!=(e&$.a.Dielectric)?"Dielectric":t}},{key:"addSelectionRenderOptions",value:function(e,t){var n=t.length-t.filter((function(e){return e.name==Q.a.SelectionLayerName})).length,r=e.map((function(e){var r="SL:"+t[e.layer].name;return new X.a(e.layer+n,r)}));e.push(new X.a(t.length-2,Q.a.SelectionLayerName)),e.push.apply(e,re(r)),e.push(new X.a(t.length-1,Q.a.HighlightLayerName))}},{key:"isViaPadKind",value:function(e){return this.holeConnecterLayerKins.some((function(t){return 0!=(t&e)}))}},{key:"isVisibleViaPadLayers",value:function(e){var t=this;return e.some((function(e){return e.isVisible&&(t.isViaPadKind(e.kind)||e.searchName===$.b.MultiLayer)}))}},{key:"isHolesLayer",value:function(e){return!!e&&(e.searchName.startsWith("Pad Holes")||e.searchName.startsWith("Via Holes"))}},{key:"getActiveForRenderOptions",value:function(e,t){var n=(t||[]).find((function(t){return t.id===(null==e?void 0:e.layer)})),r=0;return n&&(r|=n.isActive?1:r,r|=0!=(n.kind&$.a.Overlay)?2:r,r|=n.searchName===$.b.MultiLayer?4:r,r|=this.isHolesLayer(n)?8:r),r}},{key:"getLayerSortNumber",value:function(e,t){var n=e.z_range,r=t.z_range,i=-(n[0]+r[1]),o=-(n[0]+r[1]);if(i!==o)return i-o;var a=Number(e.is_cutout)^Number(e.is_inverted)?0:1,c=Number(t.is_cutout)^Number(t.is_inverted)?0:1;return a!==c?a-c:e.index-t.index}}])&&ce(t.prototype,n),i&&ce(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),de=fe;function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function pe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ye(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ve(e,t){return(ve=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function me(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=we(e);if(t){var i=we(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ge(this,n)}}function ge(e,t){if(t&&("object"===he(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return be(e)}function be(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function we(e){return(we=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.BoardShape=0]="BoardShape",e[e.Background=1]="Background",e[e.Other=2]="Other",e[e.DrillDrawing=3]="DrillDrawing",e[e.Mechanichal=4]="Mechanichal",e[e.KeepOut=5]="KeepOut",e[e.DrillGuide=6]="DrillGuide",e[e.Plane=7]="Plane",e[e.SolderMask=8]="SolderMask",e[e.Paste=9]="Paste",e[e.Signal=10]="Signal",e[e.Current=11]="Current",e[e.Overlay=12]="Overlay",e[e.MultiLayer=13]="MultiLayer",e[e.Holes=14]="Holes",e[e.Ignored=15]="Ignored"}(se||(se={})),function(e){e[e.Bottom=0]="Bottom",e[e.Internal=1]="Internal",e[e.Top=2]="Top"}(le||(le={}));var ke=new Map([[$.b.BoardShape,{kind:$.a.System,stackKind:se.BoardShape}],[$.b.BackgroundLayer,{kind:$.a.System,stackKind:se.Background}],[$.b.Background,{kind:$.a.System,stackKind:se.Background}],[$.b.MultiLayer,{kind:$.a.Other,stackKind:se.MultiLayer}],[$.b.TopOverlayLayer,{kind:$.a.Overlay|$.a.Top|$.a.LayerPair,stackKind:se.Overlay}],[$.b.BottomOverlayLayer,{kind:$.a.Overlay|$.a.Bottom|$.a.LayerPair,stackKind:se.Overlay}],[$.b.TopLayer,{kind:$.a.Signal|$.a.Top,stackKind:se.Signal}],[$.b.BottomLayer,{kind:$.a.Signal|$.a.Bottom,stackKind:se.Signal}],[$.b.TopPasteLayer,{kind:$.a.Paste|$.a.Top|$.a.LayerPair,stackKind:se.Paste}],[$.b.BottomPasteLayer,{kind:$.a.Paste|$.a.Bottom|$.a.LayerPair,stackKind:se.Paste}],[$.b.TopSolderLayer,{kind:$.a.Solder|$.a.Top|$.a.LayerPair,stackKind:se.SolderMask}],[$.b.BottomSolderLayer,{kind:$.a.Solder|$.a.Bottom|$.a.LayerPair,stackKind:se.SolderMask}],[$.b.PadHolesLayer,{kind:$.a.System,stackKind:se.Holes}],[$.b.ViaHolesLayer,{kind:$.a.System,stackKind:se.Holes}],[$.b.DrillGuideLayer,{kind:$.a.Other,stackKind:se.DrillGuide}],[$.b.KeepOutLayer,{kind:$.a.Other,stackKind:se.KeepOut}],[$.b.DrillDrawingLayer,{kind:$.a.Other,stackKind:se.DrillDrawing}],[$.b.SelectionsLayer,{kind:$.a.System,stackKind:se.Ignored}],[$.b.ConnectionsLayer,{kind:$.a.System,stackKind:se.Ignored}]]),Se=[[$.b.MidLayer,{kind:$.a.Signal,stackKind:se.Signal}],[$.b.InternalPlaneLayer,{kind:$.a.Signal,stackKind:se.Plane}],[$.b.MechanicalLayer,{kind:$.a.Mechanical,stackKind:se.Mechanichal}],[$.b.DielectricLayer,{kind:$.a.Dielectric,stackKind:se.Ignored}]],Pe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ve(e,t)}(a,e);var t,n,i,o=me(a);function a(){var e;pe(this,a);for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return Le(be(e=o.call.apply(o,[this].concat(n))),"logger",r.a.createLogger("NoMetadataPcbLayerManager")),e}return t=a,(n=[{key:"flipSortedLayers",value:function(e){e.reduce((function(e,t){if(!t.ignored&&t.kind!==$.a.System&&t.kind!==$.a.Other){var n=e.get(t.layerGroup);n?n.push(t):e.set(t.layerGroup,[t])}return e}),new Map).forEach((function(e){var t=e.map((function(e){return e.stackIndex}));e.forEach((function(e,n){e.stackIndex=t[t.length-n-1]}))}))}},{key:"getLayers",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e&&this.layers.length||(this.layers=this.getBoardLayers(this.scene.layers),t&&this.flipSortedLayers(this.layers)),this.layers}},{key:"flipBoard",value:function(){this.scene.flipped=!this.scene.flipped,this.layers?(this.flipSortedLayers(this.layers),this.setLayers(this.layers,!1)):this.setLayers(this.layers,this.scene.flipped),console.log("flipBoard",this.layers.map((function(e){return e.name})).join(" | "))}},{key:"createRenderOptions",value:function(e,t,n){var r=this,i=[],o=n?this.setSystemLayers(n):this.getLayers(!1,t);this.setDefaultVisibility(o),o.forEach((function(t){t.ignored||t.isVisible&&e.filter((function(e){return e.name===t.name})).sort((function(e,t){return(Number(e.is_cutout)^Number(e.is_inverted)?0:1)-(Number(t.is_cutout)^Number(t.is_inverted)?0:1)})).forEach((function(e){return i.push(new X.a(e.index,e.name))}))})),i.sort((function(e,t){return r.getActiveForRenderOptions(e,o)-r.getActiveForRenderOptions(t,o)})),this.addSelectionRenderOptions(i,e);var a=i.filter((function(e){return e.layer%3==0||e.layerName.startsWith("Highligh")})).reduce((function(e,t,n){return e+" | [".concat(t.layer,"] ").concat(t.layerName," ")}),"Layers to render: ");return this.logger.LogInfo(a),i}},{key:"getBoardLayers",value:function(e){var t=this,n=[Q.a.SelectionLayerName,Q.a.HighlightLayerName,"NoLayer"];return Array.from(new Map(e.filter((function(e){return!n.includes(e.name)})).map((function(e){return[e.name,e]}))).values()).map((function(e){var n={layer:e,kind:$.a.None,group:"Unknown",stackKind:se.Ignored,levelKind:le.Internal,levelIndex:0,ignored:!0};return t.setBoardLayerInfo(n)})).sort((function(e,t){return e.stackKind!==t.stackKind?e.stackKind-t.stackKind:e.levelKind!==t.levelKind?e.levelKind-t.levelKind:t.levelIndex-e.levelIndex})).map((function(e,t){return{id:e.layer.index,metaId:-1,name:e.layer.name,searchName:e.layer.name,color:"none",layerGroup:e.group,isVisible:!(e.ignored||e.kind===$.a.Other||e.kind===$.a.System||e.kind===$.a.Mechanical),isActive:!1,ignored:e.ignored,kind:e.kind,stackIndex:t}}))}},{key:"setBoardLayerInfo",value:function(e){if(e.layer.name){var t=ke.get(e.layer.name);if(t)return e.kind=t.kind,e.stackKind=t.stackKind,0!=(e.kind&$.a.Top)&&(e.levelKind=le.Top),0!=(e.kind&$.a.Bottom)&&(e.levelKind=le.Bottom),e.group=this.defineLayerGroup(e.kind,e.group),e.ignored=e.stackKind===se.Ignored,e;var n=0,r=Se.find((function(t){var r=e.layer.name.match("".concat(t[0]," (\\d*)"));if(r&&r[0]&&"".concat(t[0]," ").concat(r[1])===r[0])return n=r[1]?Number.parseInt(r[1]):n,!0}));if(r)return e.kind=r[1].kind,e.stackKind=r[1].stackKind,e.levelIndex=n,e.group=this.defineLayerGroup(e.kind,e.group),e.ignored=e.stackKind===se.Ignored,e}return e}},{key:"setSystemLayers",value:function(e){var t=this,n=function(n){if(!e.find((function(e){return e.kind===$.a.System&&e.searchName===n}))){var r=t.layers.find((function(e){return e.searchName===n}));r&&e.push(r)}};return n($.b.BoardShape),n($.b.BackgroundLayer),n($.b.Background),n($.b.ViaHolesLayer),n($.b.PadHolesLayer),e.sort((function(e,t){return e.stackIndex-t.stackIndex}))}},{key:"setDefaultVisibility",value:function(e){var t=this.isVisibleViaPadLayers(e);e.forEach((function(e){e.kind!==$.a.System||e.searchName!==$.b.BoardShape&&e.searchName!==$.b.BackgroundLayer&&e.searchName!==$.b.Background||(e.isVisible=!0),e.kind===$.a.System&&e.searchName===$.b.ViaHolesLayer&&(e.isVisible=t),e.kind===$.a.System&&e.searchName===$.b.PadHolesLayer&&(e.isVisible=t),e.searchName===$.b.MultiLayer&&t&&(e.isVisible=t)}))}}])&&ye(t.prototype,n),i&&ye(t,i),Object.defineProperty(t,"prototype",{writable:!1}),a}(fe);function Oe(e){return(Oe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function De(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){Ce(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Me(e,t){return(Me=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Re(e);if(t){var i=Re(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Ne(this,n)}}function Ne(e,t){if(t&&("object"===Oe(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return je(e)}function je(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Re(e){return(Re=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ae;!function(e){e[e.topSystem=0]="topSystem",e[e.top=1]="top",e[e.middle=2]="middle",e[e.plane=3]="plane",e[e.bottom=4]="bottom",e[e.mechanical=5]="mechanical",e[e.other=6]="other",e[e.bottomSystem=7]="bottomSystem",e[e.ignored=8]="ignored",e[e.max=9]="max"}(Ae||(Ae={}));var Te=r.a.createLogger("PcbLayerManager"),_e=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Me(e,t)}(a,e);var t,n,i,o=Ie(a);function a(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),Ce(je(n=o.call(this,e)),"metaLayers",new Map),Ce(je(n),"metadataLayers",void 0),Ce(je(n),"metaProjectTypeName",void 0);var r=j.a.instance;return n.metaProjectTypeName=r.metadata.projectTypeName,n.initMetaLayers(r.getDocumentLayers(t)),n}return t=a,(n=[{key:"getLayers",value:function(){var e,t=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(n&&null!==(e=this.layers)&&void 0!==e&&e.length)return this.layers;this.layers=this.getBoardLayers(this.scene.layers,!1),this.IsKiCadProject()&&(this.layers=this.layers.filter((function(e){return t.metadataLayers.find((function(t){return t.searchName==e.name}))})));var r=-3;this.metadataLayers.forEach((function(e){var n=t.layers.find((function(t){return t.name===e.searchName}));if(n)n.name=e.name,n.color=e.color,n.metaId=e.id,n.stackIndex=e.stackIndex,n.kind=e.kind,void 0!==e.isVisible&&(n.isVisible=e.isVisible),void 0!==e.ignored?n.ignored=e.ignored:void 0===e.stackIndex&&(n.ignored=!0),e.kind&&(n.layerGroup=t.getLayerGroup(n,e.kind));else{var i={id:r--,name:e.name,color:e.color,metaId:e.id,ignored:e.ignored,searchName:e.searchName,isVisible:!0,isActive:!1,stackIndex:e.stackIndex,layerGroup:"",kind:e.kind};void 0!==e.isVisible&&(i.isVisible=e.isVisible),void 0!==e.ignored?i.ignored=e.ignored:void 0===e.stackIndex&&(i.ignored=!0),e.kind&&(i.layerGroup=t.getLayerGroup(i,e.kind)),t.layers.push(i)}}));var i=this.layers.find((function(e){return 129===e.kind}));return i&&null!=i&&i.isVisible&&(i.isActive=!0),this.layers}},{key:"flipBoard",value:function(){var e=this,t=this.scene;t.flipped=!t.flipped;var n=new Map;this.metadataLayers.slice().sort((function(e,t){return e.stackIndex-t.stackIndex})).forEach((function(t){var r=e.getLayerGroup(t,t.kind);if(r&&t.stackIndex){var i=n.get(r);i?i.push(t):n.set(r,[t])}})),n.forEach((function(e,t){if("System Colors"!==t&&"Other"!==t&&"Dielectric"!==t){var n=e.map((function(e){return e.stackIndex}));e.forEach((function(e,t){e.stackIndex=n[n.length-t-1]}))}})),this.setLayers(this.layers,!1),r.a.bus.emit("PcbEngine:flipped",this.flipped)}},{key:"createRenderOptions",value:function(e,t,n){var r,i=this,o=[],a=[$.b.BackgroundLayer,$.b.Background];if((r=n?this.setViaPadFilter(n):this.getBoardLayers(e,t)).forEach((function(t){var n;t.ignored||t.isVisible&&(!i.metaLayers||null!==(n=i.metaLayers.get(t.searchName))&&void 0!==n&&n.stackIndex)&&e.filter((function(e){return"NoLayer"!=e.name&&t.id<=e.index&&e.index<t.id+3})).forEach((function(e){return o.push(new X.a(e.index,e.name))}))})),!o.find((function(e){return e.layerName===$.b.BoardShape}))){var c=e.find((function(e){return e.name===$.b.BoardShape}));c&&o.push(new X.a(c.index,c.name))}if(!o.find((function(e){return a.includes(e.layerName)}))){var u=e.find((function(e){return a.includes(e.name)}));u&&o.push(new X.a(u.index,u.name))}if(this.metaLayers.size>0){var s=this.metaLayers;o.sort((function(t,n){var r,o,a,c,u=i.getLayerName(t.layerName),l=i.getLayerName(n.layerName),f=null!==(r=null===(o=s.get(u))||void 0===o?void 0:o.stackIndex)&&void 0!==r?r:0,d=null!==(a=null===(c=s.get(l))||void 0===c?void 0:c.stackIndex)&&void 0!==a?a:0;if(f!==d)return d-f;var h=e[t.layer],p=e[n.layer];return i.getLayerSortNumber(h,p)})).sort((function(e,t){var n=e.layerName===$.b.BoardShape?0:2,r=t.layerName===$.b.BoardShape?0:2;return a.includes(e.layerName)&&(n=1),a.includes(t.layerName)&&(r=1),n-r}))}else{var l={};o.reverse().forEach((function(e,t){l[e.layer]=Math.floor(t/3)})),o.sort((function(t,n){l[t.layer],l[n.layer];var r=e[t.layer],o=e[n.layer];return i.getLayerSortNumber(r,o)}))}o.sort((function(e,t){return i.getActiveForRenderOptions(e,r)-i.getActiveForRenderOptions(t,r)})),this.addSelectionRenderOptions(o,e);var f=o.filter((function(e){return e.layer%3==0||e.layerName.startsWith("Highligh")})).reduce((function(e,t,n){return e+" | [".concat(t.layer,"] ").concat(t.layerName," ")}),"Layers to render: ");return Te.LogInfo(f),o}},{key:"getLayerName",value:function(e){return e===$.b.BoardShape||e===$.b.BackgroundLayer?$.b.Background:e}},{key:"initMetaLayers",value:function(e){var t,n=this;if(this.metadataLayers=e.filter((function(e){return e.stackIndex})),null===(t=this.metadataLayers)||void 0===t||!t.length)throw Te.LogError("Empty metadata layers."),new Error("Empty metadata layers.");this.metadataLayers.forEach((function(e){return n.metaLayers.set(e.searchName,e)}))}},{key:"groupLayers",value:function(e){var t=["Pad Holes","Via Holes","Connections"],n=[$.b.BoardShape,$.b.BackgroundLayer,$.b.Background],r=[$.b.MultiLayer,"Drill Guide","Keep-Out Layer","Drill Drawing"],i=[];i.length=Ae.max;for(var o=0;o<i.length;o++)i[o]=[];return e.forEach((function(e){t.indexOf(e.name)>=0?i[Ae.topSystem].push(e):e.name.startsWith("Top")?i[Ae.top].push(e):e.name.startsWith("Mid-Layer")?i[Ae.middle].push(e):e.name.startsWith("Internal Plane")?i[Ae.plane].push(e):e.name.startsWith("Bottom")?i[Ae.bottom].push(e):e.name.startsWith("Mechanical")?i[Ae.mechanical].push(e):r.indexOf(e.name)>=0?i[Ae.other].push(e):n.indexOf(e.name)>=0?i[Ae.bottomSystem].push(e):i[Ae.ignored].push(e)})),i}},{key:"updateGroupNames",value:function(e){var t=function(e){return"Paste"===e?"Paste Mask":"Overlay"===e?"Silkscreen":"Solder"===e?"Solder Mask":"Layer"===e?"Copper":"none"};e[Ae.mechanical].forEach((function(e){e.isVisible=!1,e.layerGroup="Mechanical"})),e[Ae.other].forEach((function(e){e.isVisible=!1,e.layerGroup="Other"})),e[Ae.middle].forEach((function(e){e.layerGroup="Copper"})),e[Ae.plane].forEach((function(e){e.layerGroup="Copper"})),e[Ae.topSystem].forEach((function(e){e.layerGroup="System Colors"})),e[Ae.bottomSystem].forEach((function(e){e.layerGroup="System Colors"})),e[Ae.top].forEach((function(e){e.layerGroup=t(e.name.replace("Top ",""))})),e[Ae.bottom].forEach((function(e){e.layerGroup=t(e.name.replace("Bottom ",""))}))}},{key:"getLayerGroup",value:function(e,t){if(0!=(t&$.a.Signal))return"Copper";if(0!=(t&$.a.LayerPair)){if(e.searchName.endsWith("Paste"))return"Paste Mask";if(e.searchName.endsWith("Overlay"))return"Silkscreen";if(e.searchName.endsWith("Solder"))return"Solder Mask"}return 0!=(t&$.a.Plane)?"Copper":0!=(t&$.a.Mechanical)?"Mechanical":0!=(t&$.a.Other)?"Other":0!=(t&$.a.System)?"System Colors":0!=(t&$.a.Dielectric)?"Dielectric":e.layerGroup}},{key:"sortTopOrBottomLayers",value:function(e,t){var n=function(n){var r=n.name.replace(e+" ","");return"Pad Master"===r?t.length:"Paste"===r?t.length-1:"Overlay"===r?t.length-2:"Solder"===r?t.length-3:"Layer"===r?t.length-4:0};return t.sort((function(e,t){return n(e)-n(t)}))}},{key:"sortLayersByIndex",value:function(e){var t=function(e){return parseInt(e.name.replace(/[^0-9\.]+/g,""))};return e.sort((function(e,n){return t(e)-t(n)}))}},{key:"sortLayers",value:function(e){e[Ae.middle]=this.sortLayersByIndex(e[Ae.middle]),e[Ae.plane]=this.sortLayersByIndex(e[Ae.plane]),e[Ae.mechanical]=this.sortLayersByIndex(e[Ae.mechanical]),e[Ae.top]=this.sortTopOrBottomLayers("Top",e[Ae.top]).reverse(),e[Ae.bottom]=this.sortTopOrBottomLayers("Bottom",e[Ae.bottom])}},{key:"getStack",value:function(e,t){var n=[],r=[];return e[Ae.top].forEach((function(e){return n.push(e)})),e[Ae.middle].forEach((function(e){return n.push(e)})),e[Ae.plane].forEach((function(e){return n.push(e)})),e[Ae.bottom].forEach((function(e){return n.push(e)})),t&&n.reverse(),e[Ae.topSystem].forEach((function(e){return r.push(e)})),n.forEach((function(e){return r.push(e)})),e[Ae.mechanical].forEach((function(e){return r.push(e)})),e[Ae.other].forEach((function(e){return r.push(e)})),e[Ae.bottomSystem].forEach((function(e){return r.push(e)})),e[Ae.ignored].forEach((function(e){return r.push(e)})),r}},{key:"getBoardLayers",value:function(e,t){var n=e.slice(0).filter((function(e){return e.index%3==0&&e.name!==Q.a.SelectionLayerName&&"NoLayer"!=e.name})).map((function(e){return{id:e.index,metaId:-1,name:e.name,searchName:e.name,color:"none",layerGroup:"none",isVisible:!0,isActive:!1,ignored:!1,kind:0,stackIndex:0}})),r=this.groupLayers(n);return r[Ae.ignored].forEach((function(e){return e.ignored=!0})),this.updateGroupNames(r),this.sortLayers(r),this.getStack(r,t)}},{key:"setViaPadFilter",value:function(e){var t=this;if(!this.isVisibleViaPadLayers(e))return e.filter((function(e){return!t.isHolesLayer(e)}));var n=e.find((function(e){return e.searchName===$.b.MultiLayer}));return n&&(n.isVisible=!0),e=this.setViaPadHolesFilter(e)}},{key:"setViaPadHolesFilter",value:function(e){var t=this,n=this.metadataLayers.filter((function(e){return t.isHolesLayer(e)}));return e=e.slice(),null==n||n.forEach((function(n){var r=e.find((function(e){return e.metaId===n.id}));if(r)r.isVisible=!0;else{var i,o,a=De(De({},n),{},{metaId:n.id,isVisible:!0});a.id=null!==(i=null===(o=t.scene.layers.find((function(e){return e.name===a.searchName})))||void 0===o?void 0:o.index)&&void 0!==i?i:-999,e.push(a)}})),e}},{key:"IsKiCadProject",value:function(){return"KiCad"==this.metaProjectTypeName}}])&&xe(t.prototype,n),i&&xe(t,i),Object.defineProperty(t,"prototype",{writable:!1}),a}(de);function Ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Be=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"createLayerManager",value:function(e,t){var n=j.a.instance;return n.metadata&&0!==n.getDocumentLayers(t).length?new _e(e,t):new Pe(e)}}])&&Ve(t.prototype,n),r&&Ve(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Ge=n(316),Fe=n(146);function Ue(e){return(Ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function He(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */He=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof f?t:f,o=Object.create(i.prototype),a=new S(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return O()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var c=w(a,n);if(c){if(c===l)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=s(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,a),o}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function f(){}function d(){}function h(){}var p={};c(p,i,(function(){return this}));var y=Object.getPrototypeOf,v=y&&y(y(P([])));v&&v!==t&&n.call(v,i)&&(p=v);var m=h.prototype=f.prototype=Object.create(p);function g(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var r;this._invoke=function(i,o){function a(){return new t((function(r,a){!function r(i,o,a,c){var u=s(e[i],e,o);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==Ue(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,a,c)}),(function(e){r("throw",e,a,c)})):t.resolve(f).then((function(e){l.value=e,a(l)}),(function(e){return r("throw",e,a,c)}))}c(u.arg)}(i,o,r,a)}))}return r=r?r.then(a,a):a()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=s(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function P(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:O}}function O(){return{value:void 0,done:!0}}return d.prototype=h,c(m,"constructor",h),c(h,"constructor",d),d.displayName=c(h,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,c(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},g(b.prototype),c(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new b(u(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(m),c(m,a,"Generator"),c(m,i,(function(){return this})),c(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;k(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:P(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}function Ke(e,t,n,r,i,o,a){try{var c=e[o](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,i)}function We(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){Ke(o,r,i,a,c,"next",e)}function c(e){Ke(o,r,i,a,c,"throw",e)}a(void 0)}))}}function ze(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ze(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ye,Qe=new Uint8Array([255,216,0,200]),Xe=function(){function e(t,n){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ze(this,"scene",void 0),Ze(this,"logger",void 0),Ze(this,"layerId",void 0),Ze(this,"linesNodeId",null),Ze(this,"selectedLinesNodeId",null),Ze(this,"selectedNode",null),Ze(this,"isSelected",!1),Ze(this,"toggleLinesVisibility",null),Ze(this,"renderMode",N.b.Render2D),Ze(this,"pcbDocId",void 0),Ze(this,"onSelectedItem",function(){var e=We(He().mark((function e(t){var n;return He().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i.isSelected=!!t,i.clearSelection(),t&&i.addSelection(t),n=null===i.toggleLinesVisibility?i.renderMode===N.b.Render2D:i.toggleLinesVisibility,i.setVisibleUnroutedLines(n);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.layerId=t.layers.length-1,this.scene=t,this.pcbDocId=n,this.logger=r.a.createLogger("UnroutedConnectionBuilder"),this.setRenderMode=this.setRenderMode.bind(this),r.a.bus.on("PcbEngine:changedRenderMode",this.setRenderMode),r.a.bus.on("select",this.onSelectedItem)}var t,n,i,o,a;return t=e,(n=[{key:"dispose",value:function(){r.a.bus.off("PcbEngine:changedRenderMode",this.setRenderMode),r.a.bus.off("select",this.onSelectedItem)}},{key:"addConnectionsToScene",value:(a=We(He().mark((function e(t){var n=this;return He().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){try{var i,o,a,c,u;n.renderMode=t;var s=j.a.instance;if(null===(i=s.primitives)||void 0===i||!i.length)return;var l=s.primitives.filter((function(e){return s.getObjectId(e)===I.a.Connection&&e.pcbDocId===n.pcbDocId}));if(null==l||!l.length)return;n.linesNodeId=null!==(o=null===(a=n.addConnectionNodeToScene(l,n.layerId,Qe))||void 0===a?void 0:a.GetId())&&void 0!==o?o:null;var f=Fe.a.toGrayscale(Qe);n.selectedLinesNodeId=null!==(c=null===(u=n.addConnectionNodeToScene(l,n.layerId,f))||void 0===u?void 0:u.GetId())&&void 0!==c?c:null;var d=null===n.toggleLinesVisibility?t===N.b.Render2D:n.toggleLinesVisibility;n.setVisibleUnroutedLines(d),e()}catch(e){n.logger.LogError("Failed add unrouted connections to scene.",e),r(e)}})));case 1:case"end":return e.stop()}}),e)}))),function(e){return a.apply(this,arguments)})},{key:"addConnectionNodeToScene",value:function(e,t,n){var r=this;try{var i=new Array;return e.filter((function(e){return null!=(t=e).x&&null!=t.x1&&null!=t.y&&null!=t.y1;var t})).forEach((function(e){var t=r.createLine(e,n);i.push(t)})),this.scene.addItem(t,[],[],[],[],i,[])}catch(e){return this.logger.LogError("Add connection node error.",e),null}}},{key:"createLine",value:function(e,t){return{from:[e.x/1e6,e.y/1e6,0],to:[e.x1/1e6,e.y1/1e6,0],color:t,width:1,dash:0}}},{key:"toggleVisibleUnroutedLines",value:function(e){return this.toggleLinesVisibility=e,this.setVisibleUnroutedLines(e)}},{key:"setVisibleUnroutedLines",value:(o=We(He().mark((function e(t){return He().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.linesNodeId&&this.selectedLinesNodeId){e.next=2;break}return e.abrupt("return");case 2:try{this.scene.setNodeItemsVisibility([this.linesNodeId],t&&!this.isSelected),this.scene.setNodeItemsVisibility([this.selectedLinesNodeId],t&&this.isSelected),this.selectedNode&&this.scene.setNodeItemsVisibility([this.selectedNode.GetId()],t),this.invalidateScene()}catch(e){this.logger.LogError("Set Visible = ".concat(t," for unrouted net lines."),e)}case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"setRenderMode",value:function(e){this.renderMode=e;var t=null===this.toggleLinesVisibility?e===N.b.Render2D:this.toggleLinesVisibility;this.setVisibleUnroutedLines(t)}},{key:"clearSelection",value:function(){try{this.selectedNode&&this.scene.removeItem(this.selectedNode),this.selectedNode=null}catch(e){this.logger.LogError("Remove selected node from scene.",e)}}},{key:"addSelection",value:function(e){if("net"===(null==e?void 0:e.name)&&(null==e.isPrimitiveContainer||e.isPrimitiveContainer)){var t=j.a.instance,n=e.native.primitives.map((function(e){return t.primitives[e]})).filter((function(e){return e&&t.getObjectId(e)===I.a.Connection}));null!=n&&n.length&&(this.selectedNode=this.addConnectionNodeToScene(n,this.layerId,Qe),this.invalidateScene())}}},{key:"invalidateScene",value:function(){r.a.bus.emit("PcbEngine:invalidate")}}])&&ze(t.prototype,n),i&&ze(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),$e=n(36);function qe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Je(e,t,n){return t&&qe(e.prototype,t),n&&qe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function et(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function tt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Voltage=0]="Voltage",e[e.Density=1]="Density"}(Ye||(Ye={}));var nt=Je((function e(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;et(this,e),tt(this,"mesh_id",void 0),tt(this,"position",void 0),tt(this,"rotation",void 0),tt(this,"scale",void 0),tt(this,"angle",void 0),tt(this,"material",void 0),tt(this,"matrix",void 0),this.mesh_id=t,this.material=n,this.position=i||[0,0,0],this.rotation=o||[1,1,1],this.scale=a||[1,1,1],"number"==typeof r?(this.angle=r,this.matrix=[]):(this.matrix=r,this.angle=0)}));function rt(e){return(rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function it(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ot(){return(ot="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=at(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function at(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ft(e)););return e}function ct(e,t){return(ct=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function ut(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ft(e);if(t){var i=ft(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return st(this,n)}}function st(e,t){if(t&&("object"===rt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return lt(e)}function lt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ft(e){return(ft=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function dt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ht=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ct(e,t)}(o,e);var t,n,r,i=ut(o);function o(e,t,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o);var a=[new U.a(new Uint8Array([255,255,255,255]),0,!1,!1,!1)];return dt(lt(r=i.call(this,e,[],a,void 0,void 0,t,n)),"activeMeshId",void 0),dt(lt(r),"activeNodeItem",void 0),dt(lt(r),"viewportZoom_",void 0),dt(lt(r),"viewportCenter_",void 0),r.activeNodeItem=null,r.viewportZoom_=r.defZoom,r.viewportCenter_=[0,0],r.logger.LogInfo("Simulation scene successfully initialized."),r}return t=o,(n=[{key:"viewport",get:function(){return ot(ft(o.prototype),"viewport",this)}},{key:"renderPath",get:function(){return ot(ft(o.prototype),"renderPath",this)}},{key:"parentScene",get:function(){return ot(ft(o.prototype),"parentScene",this)}},{key:"viewportZoom",get:function(){return this.isRoot?this.viewportZoom_:this.parentScene.viewportZoom}},{key:"viewportCenter",get:function(){return this.isRoot?this.viewportCenter_:this.parentScene.viewportCenter}},{key:"createRenderPath",value:function(){return this.scene.CreateRenderPath()}},{key:"addViewport",value:function(e){return this.scene.AddViewport2D(e)}},{key:"clear",value:function(){this.tryClear()}},{key:"getZoom",value:function(){return this.viewport.GetZoom()}},{key:"renderScene",value:function(){this.renderPath.SelectViewport2D(this.viewport),this.renderPath.Render(this.rootNode)}},{key:"setCenterOffset",value:function(e,t){this.viewport.SetCenter(this.viewportCenter)}},{key:"setSelection",value:function(e){}},{key:"setZoom",value:function(e){e=this.defZoom/e,this.viewportZoom_=e,this.viewport.SetZoom(e)}},{key:"zoomToFit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.8,r=n,i=this.renderOptions.filter((function(e){return e.layerName!==Q.a.HighlightLayerName})).map((function(e){return e.layer})),o=i.length>0?i:this.layers.map((function(e){return e.index})),a=this.rootNode.GetBoxForLayers(o);null==e&&(e=[a[0],a[1],a[2]]),null==t&&(t=[a[3],a[4],a[5]]),this.viewport.FitFixedView(e,t,r),this.viewport.SetZoom(this.viewportZoom)}},{key:"setFitFixedView",value:function(e,t,n){if(n||(n=.8),null==e||null==t){var r=this.renderOptions.map((function(e){return e.layer})),i=this.rootNode.GetBoxForLayers(r);null==e&&(e=[i[0],i[1],i[2]]),null==t&&(t=[i[3],i[4],i[5]])}this.viewport.FitFixedView(e,t,n)}},{key:"updateSimulationMesh",value:function(e){this.tryClear();var t=this.scene.AddMesh(e);this.activeMeshId=t;var n=new nt(t,0,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],[0,0,0],[0,0,1],[1,1,1]);if(this.activeNodeItem=this.rootNodeData.AddItem({GetLayerGeometry:function(){return[]},GetMeshParts:function(){return[n]}}),!this.activeNodeItem)throw new Error("RootNodeItem didn't add")}},{key:"viewportToWorld",value:function(e){return this.viewport.ViewportToWorld(e)}},{key:"tryClear",value:function(){return!!this.activeMeshId&&(this.activeNodeItem&&this.rootNodeData.DeleteItem(this.activeNodeItem),this.scene.DeleteMesh(this.activeMeshId),this.activeMeshId=void 0,this.activeNodeItem=null,!0)}}])&&it(t.prototype,n),r&&it(t,r),Object.defineProperty(t,"prototype",{writable:!1}),o}(n(464).a);function pt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function yt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var vt=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseScene=t,this.simulation=n,this.selectionManager=r,yt(this,"beforeRenderHandler",void 0),yt(this,"renderHandler",void 0),yt(this,"subscribed",void 0),yt(this,"grayMaterials",void 0),yt(this,"grayMaterialsApplied",void 0),yt(this,"materials",void 0),this.beforeRenderHandler=this.onBeforeRender.bind(this),this.renderHandler=this.onRender.bind(this),this.grayMaterialsApplied=!1,this.subscribed=!1}var t,n,r;return t=e,(n=[{key:"deactivate",value:function(){this.setNormalMaterials()}},{key:"setNormalMaterials",value:function(){this.grayMaterialsApplied&&this.materials&&(this.baseScene.setMaterials(this.materials),this.grayMaterialsApplied=!1,this.baseScene.setDirty(!0))}},{key:"startRendering",value:function(){this.subscribed||(this.subscribed=!0,this.baseScene.on("beforeRender",this.beforeRenderHandler),this.baseScene.on("rendered",this.renderHandler))}},{key:"stopRendering",value:function(){this.subscribed&&(this.subscribed=!1,this.baseScene.off("beforeRender",this.beforeRenderHandler),this.baseScene.off("rendered",this.renderHandler))}},{key:"copyMaterials",value:function(){this.grayMaterials||(this.materials=this.baseScene.getMaterials(),this.grayMaterials=this.toGrayscaleMaterials(this.materials))}},{key:"onBeforeRender",value:function(){this.copyMaterials(),this.setGrayMaterials()}},{key:"onRender",value:function(){this.simulation.render(!1)}},{key:"setGrayMaterials",value:function(){this.subscribed&&!this.grayMaterialsApplied&&this.grayMaterials&&(this.baseScene.setMaterials(this.grayMaterials),this.grayMaterialsApplied=!0,this.baseScene.setDirty(!0))}},{key:"toGrayscaleMaterials",value:function(e){return e.map((function(e){var t=Fe.a.toGrayscale(e.Diffuse);return new U.a(t,e.Hatching,e.Bordered,!1,!0)}))}}])&&pt(t.prototype,n),r&&pt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),mt=n(259),gt=n(450),bt=n(462),wt=n(461);function Lt(e){return(Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function kt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function St(e,t){return(St=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Pt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Dt(e);if(t){var i=Dt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Ot(this,n)}}function Ot(e,t){if(t&&("object"===Lt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Et(e)}function Et(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Dt(e){return(Dt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Mt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&St(e,t)}(o,e);var t,n,r,i=Pt(o);function o(e,t,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o);var a=[new U.a(new Uint8Array([255,255,255,255]),0,!1,!1,!1)];return xt(Et(r=i.call(this,e,[],a,void 0,void 0,t,n)),"activeMeshId",void 0),xt(Et(r),"activeNodeItem",void 0),r.activeNodeItem=null,r.updatePerspectiveMatrix(),r.setZoom(.4),r.logger.LogInfo("Simulation scene successfully initialized."),r}return t=o,(n=[{key:"createRenderPath",value:function(){return this.scene.CreateRenderPath()}},{key:"addViewport",value:function(e){return this.scene.AddViewport(e)}},{key:"getForward",value:function(){return this.viewport.GetForward()}},{key:"getEye",value:function(){return this.viewport.GetEye()}},{key:"getAt",value:function(){return this.viewport.GetAt()}},{key:"getUp",value:function(){return this.viewport.GetUp()}},{key:"getView",value:function(){return this.viewport.GetView()}},{key:"getInverseView",value:function(){return this.viewport.GetInverseView()}},{key:"clear",value:function(){this.tryClear()}},{key:"getZoom",value:function(){return this.viewportOffset}},{key:"renderScene",value:function(){var e=this.renderPath;e.SelectViewport(this.viewport),e.Render(this.rootNode)}},{key:"setCenterOffset",value:function(e,t){var n=window.vec2,r=window.vec3,i=window.quat,o=n.fromValues(e,t),a=n.scale(n.create(),o,this.rotationSensitivity),c=r.transformQuat(r.create(),r.fromValues(0,1,0),this.viewportQuat);r.normalize(c,c);var u=i.setAxisAngle(i.create(),c,a[0]);i.mul(this.viewportQuat,u,this.viewportQuat);var s=r.transformQuat(r.create(),r.fromValues(1,0,0),this.viewportQuat);r.normalize(s,s);var l=i.setAxisAngle(i.create(),s,a[1]);i.mul(this.viewportQuat,l,this.viewportQuat),this.updateViewMatrix(),this.emit("centerChanged",new mt.a(e,t))}},{key:"setSelection",value:function(e){}},{key:"setZoom",value:function(e){e=this.defZoom/e,this.viewportOffset=e,this.updateViewMatrix()}},{key:"zoomToFit",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.8,r=.8;if(null==e||null==t){var i=this.getRenderLayers(),o=this.rootNode.GetBoxForLayers(i);null==e&&(e=[o[0],o[1],o[2]]),null==t&&(t=[o[3],o[4],o[5]])}if(1!=n){n/=this.getRelativeAspect(e,t);var a=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],c=(a[0]/n-a[0])/2,u=(a[1]/n-a[1])/2,s=(a[2]/n-a[2])/2;e=[e[0]-c,e[1]-u,e[2]-s],t=[t[0]+c,t[1]+u,t[2]+s]}this.fitFixedView_={boxMin:e,boxMax:t,fixedScale:r},this.viewport.FitFixedView(e,t,r),this.emit("zoomToFitChanged",new gt.a(e,t))}},{key:"setFitFixedView",value:function(e,t,n){if(n||(n=.8),null==e||null==t){var r=this.renderOptions.map((function(e){return e.layer})),i=this.rootNode.GetBoxForLayers(r);null==e&&(e=[i[0],i[1],i[2]]),null==t&&(t=[i[3],i[4],i[5]])}this.viewport.FitFixedView(e,t,n)}},{key:"updateSimulationMesh",value:function(e){this.tryClear();var t=this.scene.AddMesh(e);this.activeMeshId=t;var n=new nt(t,0,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],[0,0,0],[0,0,1],[1,1,1]);if(this.activeNodeItem=this.rootNodeData.AddItem({GetLayerGeometry:function(){return[]},GetMeshParts:function(){return[n]}}),!this.activeNodeItem)throw new Error("RootNodeItem didn't add")}},{key:"tryClear",value:function(){return!!this.activeMeshId&&(this.activeNodeItem&&this.rootNodeData.DeleteItem(this.activeNodeItem),this.scene.DeleteMesh(this.activeMeshId),this.activeMeshId=void 0,this.activeNodeItem=null,!0)}},{key:"getRenderLayers",value:function(){var e={};return this.layers.forEach((function(t,n){return e[n]=t.show3d})),this.renderOptions.filter((function(t){return e[t.layer]})).map((function(e){return e.layer}))}},{key:"updateViewMatrix",value:function(){var e=window.vec3,t=e.transformQuat([0,0,0],[0,0,1],this.viewportQuat);e.scale(t,t,this.viewportOffset);var n=this.viewportAt,r=e.transformQuat([0,0,0],[0,1,0],this.viewportQuat),i=e.sub([0,0,0],n,t);this.viewport.ViewSetLookAt(i,n,r)}},{key:"updatePerspectiveMatrix",value:function(){var e=wt.a.ViewportFov*Math.PI/180,t=this.canvasWidth/this.canvasHeight;this.viewport.ProjectionSetPerspective(e,t,this.viewportNear,this.viewportFar),this.scene.Resize(this.canvasWidth,this.canvasHeight)}},{key:"getRelativeAspect",value:function(e,t){var n=window.vec2,r=n.sub([0,0],t,e);n.scale(r,r,.5);var i=this.viewport.GetRectangle(),o=r[0]/r[1],a=i[2]/i[3],c=o>a?o/a*1.2:1;return c>2&&(c=1),c}}])&&kt(t.prototype,n),r&&kt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),o}(bt.a),It=n(10),Nt=n(30),jt=n(540),Rt=n.n(jt);function Ct(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function At(e,t,n){return t&&Ct(e.prototype,t),n&&Ct(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Tt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Vt=At((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;Tt(this,e),_t(this,"vertices",void 0),_t(this,"indices",void 0),_t(this,"GetVertices",(function(){return this.vertices})),_t(this,"GetIndices",(function(){return this.indices})),this.vertices=t||[],this.indices=n||[]}));function Bt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Gt(e,t,n){return t&&Bt(e.prototype,t),n&&Bt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Ft(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ut=Gt((function e(t,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ft(this,"tex_coord",void 0),Ft(this,"position",void 0),Ft(this,"normal",void 0),Ft(this,"color",void 0),this.position=t,this.normal=n,this.color=r,this.tex_coord=i}));function Ht(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,o=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){c=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw i}}return o}(e,t)||zt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Kt(e){return(Kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wt(e){return function(e){if(Array.isArray(e))return Zt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||zt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function zt(e,t){if(e){if("string"==typeof e)return Zt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Zt(e,t):void 0}}function Zt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Qt(e,t){return(Qt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Xt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Jt(e);if(t){var i=Jt(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return $t(this,n)}}function $t(e,t){if(t&&("object"===Kt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return qt(e)}function qt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Jt(e){return(Jt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function en(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var tn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Qt(e,t)}(a,e);var t,n,i,o=Xt(a);function a(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(t=o.call(this)).apiHeaders=e,en(qt(t),"probeEnabled",void 0),en(qt(t),"cache",void 0),en(qt(t),"canvasControl",void 0),en(qt(t),"currentNet",void 0),en(qt(t),"currentLayer",void 0),en(qt(t),"currentRenderMesh",void 0),en(qt(t),"currentRenderMode",void 0),en(qt(t),"currentSimulationMesh",void 0),en(qt(t),"currentViewType",void 0),en(qt(t),"isSimulationEnabled",void 0),en(qt(t),"heightOffset",void 0),en(qt(t),"logger",void 0),en(qt(t),"pcbOriginPoint",void 0),en(qt(t),"originPoint",void 0),en(qt(t),"scene2D",void 0),en(qt(t),"scene3D",void 0),t.cache={},t.currentViewType=Ye.Voltage,t.isSimulationEnabled=!1,t.logger=r.a.createLogger("SimulationManager"),t.probeEnabled=!1,t}return t=a,(n=[{key:"simulationEnabled",get:function(){return this.isSimulationEnabled}},{key:"createSimulationScene2d",value:function(e,t){if(this.scene2D)return this.scene2D.simulation;var n=new ht(null,e,"PCB_2D_Simulation_Scene");return this.scene2D=new vt(e,n,t),this.tryShowSimulation(),n}},{key:"createSimulationScene3d",value:function(e,t){if(this.scene3D)return this.scene3D.simulation;var n=new Mt(null,e,"PCB_3D_Simulation_Scene");return this.scene3D=new vt(e,n,t),this.tryShowSimulation(),n}},{key:"changeRenderMode",value:function(e){var t,n,r,i;if(this.currentRenderMode&&this.currentRenderMode!==e){switch(e){case N.a.Render2D:null===(t=this.scene3D)||void 0===t||t.setNormalMaterials(),null===(n=this.scene2D)||void 0===n||n.baseScene.render(!1);break;case N.a.Render3D:null===(r=this.scene2D)||void 0===r||r.setNormalMaterials(),null===(i=this.scene3D)||void 0===i||i.baseScene.render(!1)}this.currentRenderMode=e}else this.currentRenderMode=e}},{key:"handleOutdatedSimulation",value:function(e){var t=this,n=e.notificationComponent,r=n.instance;this.heightOffset=function(){return r.$el.offsetHeight},n.onClose((function(){t.heightOffset=void 0}))}},{key:"getSimulationValue2d",value:function(e){if(!this.probeEnabled)return null;if(this.heightOffset){var t=this.heightOffset();e=[e[0],e[1]-t]}var n=this.scene2D,r=this.currentSimulationMesh;if(!n||!r)return null;var i=n.simulation.viewportToWorld(e),o=this.getValueAtXY(r,i);return o?{x:e[0],y:e[1],value:o,units:this.getSimulationUnits()}:null}},{key:"getUniqueLayerNames",value:function(e,t){if(t&&e.Meshes.find((function(e){return e.Layer.toUpperCase()==t})))return[t];this.logger.LogInfo("Preferred layer ".concat(t," not found - selected first default layer"));var n=e.Meshes.map((function(e){return e.Layer}));return Wt(new Set(n))}},{key:"getUniqueNetNames",value:function(e,t){var n=e.Meshes;t&&0===(n=n.filter((function(e){return e.Layer.toUpperCase()==t}))).length&&(n=e.Meshes,this.logger.LogInfo("Nets for layer ".concat(t," not found - selected all nets")));var r=n.map((function(e){return e.Net}));return Wt(new Set(r))}},{key:"hideSimulation",value:function(){var e,t=this.scene3D;t&&(t.stopRendering(),t.simulation.clear(),t.setNormalMaterials(),this.currentRenderMode==N.a.Render3D&&t.baseScene.render(!1));var n=this.scene2D;n&&(n.stopRendering(),n.simulation.clear(),n.setNormalMaterials(),this.currentRenderMode==N.a.Render2D&&n.baseScene.render(!1)),null===(e=this.canvasControl)||void 0===e||e.invalidate(),this.isSimulationEnabled=!1}},{key:"loadSimulationData",value:function(e){var t=this;return this.logger.LogDebug("Load document PDN simulation: ".concat(e)),new Promise((function(n,r){fetch(e,{method:"GET",headers:t.apiHeaders}).then((function(e){if(!e.ok)throw new Error("Document simulation loading error. [".concat(e.statusText,"]"));return e.json()})).then((function(r){if(!r||"object"!==Kt(r))throw new Error("Simulation PDN data is wrong");r.BoardOriginX?(r.BoardOriginX=0,r.BoardOriginY=0,r.useOriginPoint=!0):r.useOriginPoint=!1,t.logger.LogDebug("Success load document PDN simulation: ".concat(e)),r.kind="PDNAnalyzer",n(r)})).catch((function(e){return r(e)}))}))}},{key:"loadSimulationAnsysData",value:function(e){var t=this;return this.logger.LogDebug("Load Ansys document with simulation: ".concat(e)),new Promise((function(n,r){fetch(e,{method:"GET",headers:t.apiHeaders}).then((function(e){if(!e.ok)throw new Error("Ansys document with simulation loading error. [".concat(e.statusText,"]"));return e.blob()})).then(Rt.a.loadAsync).then((function(e){for(var t in e.files)if(t.endsWith(".json"))return e.file(t).async("string");throw new Error("Not found json file with simulation data in Ansys document")})).then((function(r){var i=JSON.parse(r);if(!i||"object"!==Kt(i))throw new Error("Simulation data is wrong");i.BoardOriginX?(i.BoardOriginX=0,i.BoardOriginY=0,i.useOriginPoint=!0):i.useOriginPoint=!1,t.logger.LogDebug("Success load document simulation: ".concat(e)),i.kind="Signal Integrity",n(i)})).catch((function(e){return r(e)}))}))}},{key:"showSimulationData",value:function(e,t,n,r){this.isSimulationEnabled=!0,r=r?r.toUpperCase().replace(" ","_"):this.currentLayer?this.currentLayer:this.getUniqueLayerNames(e,"TOP_LAYER")[0].toUpperCase(),n||(n=this.currentNet?this.currentNet:this.getUniqueNetNames(e,r)[0].toUpperCase()),this.currentNet=n,this.currentLayer=r;var i="".concat(t,"-").concat(r,"-").concat(n,"-").concat(this.currentViewType),o=this.cache[i],a=e.Meshes.find((function(e){return e.Net.toUpperCase()===n&&e.Layer.toUpperCase()===r}));if(!a)return this.logger.LogDebug("Mesh for '".concat(i,"' not found")),this.currentRenderMesh=void 0,void this.clearSimulationMesh();e.useOriginPoint?this.overrideOriginPoint(e.BoardOriginX,e.BoardOriginY):this.restoreOriginPoint(),o?this.logger.LogDebug("Render mesh for '".concat(i,"' already exists")):(o=this.buildRenderMesh(a),this.logger.LogInfo("Render mesh for '".concat(i,"' has been created")),this.cache[i]=o),this.currentRenderMesh=o,this.currentSimulationMesh=a,this.tryShowSimulation()}},{key:"selectSimulationViewOption",value:function(e){switch(e){case"Voltage":this.currentViewType=Ye.Voltage;break;case"Current Density":this.currentViewType=Ye.Density;break;default:throw new Error("Simulation view option ".concat(e," is not supported"))}return!0}},{key:"startRendering",value:function(){this.scene2D&&this.scene2D.startRendering(),this.scene3D&&this.scene3D.startRendering()}},{key:"useOriginPoint",value:function(e,t){this.pcbOriginPoint=[e,t,0],this.originPoint=this.convertToInches(this.pcbOriginPoint)}},{key:"useCanvasControl",value:function(e){this.canvasControl=e}},{key:"buildRenderMesh",value:function(e){for(var t,n=[],r=e.Patches,i=0;i<r.length;i++){var o=r[i];n.push(o[0]-1),n.push(o[1]-1),n.push(o[2]-1)}var a=Ht(null!==(t=this.originPoint)&&void 0!==t?t:[0,0,0],3),c=a[0],u=a[1],s=a[2],l=Ht(this.getMeshValueRange(e),2),f=l[0],d=l[1],h=e.Vertices,p=this.getSimulationDrawData(e),y=[0,0,-1],v=new Array(h.length);for(i=0;i<h.length;i++){var m=this.convertToInches(h[i]);v[i]=new Ut([m[0]+c,m[1]+u,m[2]+s],y,this.buildColor(p[i],f,d),[0,0])}return new Vt(v,n)}},{key:"buildColor",value:function(e,t,n){var r=this.logNormalize(e,t,n),i=1;r<0?(r=0,i=0):r>1&&(r=1,i=0);var o=.66*(1-r);return this.convertHsvToRgb(o,1,1,i)}},{key:"clearSimulationMesh",value:function(){var e=this.scene2D;e&&e.simulation.clear();var t=this.scene3D;t&&t.simulation.clear()}},{key:"convertToInches",value:function(e){return[1e-6*e[0],1e-6*e[1],1e-6*e[2]]}},{key:"convertHsvToRgb",value:function(e,t,n,r){var i=0,o=0,a=0,c=Math.floor(6*e),u=6*e-c,s=n*(1-t),l=n*(1-u*t),f=n*(1-(1-u)*t);switch(c%6){case 0:i=n,o=f,a=s;break;case 1:i=l,o=n,a=s;break;case 2:i=s,o=n,a=f;break;case 3:i=s,o=l,a=n;break;case 4:i=f,o=s,a=n;break;case 5:i=n,o=s,a=l}return new Uint8Array([Math.round(255*i),Math.round(255*o),Math.round(255*a),Math.round(255*r)])}},{key:"getValueAtXY",value:function(e,t){for(var n,r=Ht(null!==(n=this.originPoint)&&void 0!==n?n:[0,0,0],3),i=r[0],o=r[1],a=r[2],c=e.Patches,u=this.getSimulationDrawData(e),s=e.Vertices,l=0;l<c.length;l++){var f=c[l],d=f[0]-1,h=f[1]-1,p=f[2]-1,y=this.convertToInches(s[d]),v=this.convertToInches(s[h]),m=this.convertToInches(s[p]),g=this.ptInTriangle_UVW(t,[y[0]+i,y[1]+o,y[2]+a],[v[0]+i,v[1]+o,v[2]+a],[m[0]+i,m[1]+o,m[2]+a]);if(g)return u[d]*g[0]+u[h]*g[1]+u[p]*g[2]}}},{key:"getMeshValueRange",value:function(e){for(var t=1e9,n=-1e9,r=this.getSimulationDrawData(e),i=0;i<r.length;i++){var o=r[i];o<t&&(t=o),o>n&&(n=o)}return t===n&&(n+=1),[t,n]}},{key:"getSimulationDrawData",value:function(e){switch(this.currentViewType?this.currentViewType:Ye.Voltage){case Ye.Voltage:return e.Voltage;case Ye.Density:return e.CurrentDensity}}},{key:"getSimulationUnits",value:function(){switch(this.currentViewType?this.currentViewType:Ye.Voltage){case Ye.Voltage:return It.k.voltage;case Ye.Density:return It.k.currentDensity}}},{key:"overrideOriginPoint",value:function(e,t){this.originPoint=[e,t,0]}},{key:"linearNormalize",value:function(e,t,n){return n-t<5e-324?1:(e-t)/(n-t)}},{key:"logNormalize",value:function(e,t,n){return n-t<5e-324?1:n-t<1e3?this.linearNormalize(e,t,n):(t<0&&(e+=-t,n+=-t,t=0),t<1&&(e+=1,t+=1,n+=1),(Math.log10(e)-Math.log10(t))/(Math.log10(n)-Math.log10(t)))}},{key:"ptInTriangle_UVW",value:function(e,t,n,r){var i=t[0],o=t[1],a=n[0]-i,c=n[1]-o,u=r[0]-i,s=r[1]-o,l=e[0]-i,f=e[1]-o,d=a*s-u*c;if(0==d)return[];var h=(l*s-u*f)/d;if(!(h<0||h>1)){var p=(a*f-l*c)/d;if(!(p<0||p>1)){var y=1-h-p;if(!(y<0||y>1))return[y,h,p]}}}},{key:"restoreOriginPoint",value:function(){this.pcbOriginPoint?this.originPoint=this.convertToInches([this.pcbOriginPoint[0],this.pcbOriginPoint[1],0]):this.originPoint=this.convertToInches([0,0,0])}},{key:"tryShowSimulation",value:function(){var e,t=this.currentRenderMesh;if(!t)return!1;var n=this.scene2D;n&&(n.selectionManager.clearSelection(!1),n.simulation.updateSimulationMesh(t));var r=this.scene3D;return r&&(r.selectionManager.clearSelection(!1),r.simulation.updateSimulationMesh(t)),null===(e=this.canvasControl)||void 0===e||e.invalidate(),this.emit("SHOW"),!0}}])&&Yt(t.prototype,n),i&&Yt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),a}(Nt.a),nn=n(463),rn=n(554),on=n(239);function an(e){return(an="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function cn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return un(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return un(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw o}}}}function un(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function sn(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */sn=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof f?t:f,o=Object.create(i.prototype),a=new S(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return O()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var c=w(a,n);if(c){if(c===l)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=s(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,a),o}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function f(){}function d(){}function h(){}var p={};c(p,i,(function(){return this}));var y=Object.getPrototypeOf,v=y&&y(y(P([])));v&&v!==t&&n.call(v,i)&&(p=v);var m=h.prototype=f.prototype=Object.create(p);function g(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var r;this._invoke=function(i,o){function a(){return new t((function(r,a){!function r(i,o,a,c){var u=s(e[i],e,o);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==an(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,a,c)}),(function(e){r("throw",e,a,c)})):t.resolve(f).then((function(e){l.value=e,a(l)}),(function(e){return r("throw",e,a,c)}))}c(u.arg)}(i,o,r,a)}))}return r=r?r.then(a,a):a()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=s(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function P(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:O}}function O(){return{value:void 0,done:!0}}return d.prototype=h,c(m,"constructor",h),c(h,"constructor",d),d.displayName=c(h,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,c(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},g(b.prototype),c(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,n,r,i,o){void 0===o&&(o=Promise);var a=new b(u(t,n,r,i),o);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(m),c(m,a,"Generator"),c(m,i,(function(){return this})),c(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;k(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:P(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}function ln(e,t,n,r,i,o,a){try{var c=e[o](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,i)}function fn(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){ln(o,r,i,a,c,"next",e)}function c(e){ln(o,r,i,a,c,"throw",e)}a(void 0)}))}}function dn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function hn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var pn=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),hn(this,"currentDocumentIndex",0),hn(this,"currentSimulationType",void 0),hn(this,"documents",[]),hn(this,"logger",r.a.createLogger("PcbEngine")),hn(this,"metadata",void 0),hn(this,"layerFactory",void 0),hn(this,"layerManager_",void 0),hn(this,"canvasControl",void 0),hn(this,"currentPcbRenderer",void 0),hn(this,"pcbLoaded",void 0),hn(this,"controlDiv",void 0),hn(this,"selectionNodesObserver",void 0),hn(this,"selectionItemsObserver",void 0),hn(this,"engineFsm",void 0),hn(this,"padAppearanceManager",void 0),hn(this,"simulationManager",void 0),hn(this,"renderDataMap",void 0),hn(this,"lastLoadedDocumentName",void 0),hn(this,"currentDocumentLocation",void 0),hn(this,"recoveryLayers",void 0),hn(this,"listObjectIds",void 0),hn(this,"unroutedConnectionBuilder",void 0),this.engineFsm=new k(this),this.layerFactory=new Be,this.pcbLoaded=!1,this.simulationManager=new tn(r.a.apiHeaders),this.engineFsm.on("SETUP",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("SETUP_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("INIT",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("INIT_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("RENDER",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("RENDER_COMPLETED",(function(){return t.logger.LogDebug(t.engineFsm.getState())})),this.engineFsm.on("CRASHED",(function(e){var n,r,i;return t.logger.LogDebug(t.engineFsm.getState()+" with error "+(null!==(n=null!==(r=null===(i=e.error)||void 0===i?void 0:i.message)&&void 0!==r?r:e.error)&&void 0!==n?n:e))})),this.engineFsm.on("SHOW",(function(e){return t.logger.LogDebug(t.engineFsm.getState()+" for render mode "+e.renderMode)})),this.renderDataMap=new Map,this.selectionItemsObserver=new S.e,r.a.bus.registerEvent("PcbEngine:dataReadyForSnappingProcessing")}var t,n,o,a,c,u,s,l,f,d;return t=e,(n=[{key:"pcbRenderer",get:function(){return this.currentPcbRenderer}},{key:"setup",value:function(e){return this.engineFsm.goToSetup(e)}},{key:"name",get:function(){return"PcbEngine"}},{key:"comment",get:function(){return"PCB documents handler engine"}},{key:"dependencies",get:function(){return["graphite.engine"]}},{key:"metaInfo",get:function(){return this}},{key:"events",get:function(){return["PcbEngine:didDocumentAttach","PcbEngine:didDocumentDettach","PcbEngine:didDocumentAttachError","PcbEngine:beforeDocumentLoad","PcbEngine:afterDocumentLoad","PcbEngine:beforeImportPCB","PcbEngine:afterImportPCB","LayerManager:changedLayers","PcbEngine:flipped","PcbEngine:layerManagerCreated","PcbEngine:select","PcbEngine:clearSelection","PcbEngine:selectNodes","PcbEngine:highlightNodes","PcbEngine:highlight","PcbEngine:willMeasure","PcbEngine:didMeasure","PcbEngine:cancelMeasure","PcbEngine:measuring","PcbEngine:documents","PcbEngine:documentChanged","PcbEngine:showDocument","PcbEngine:setActiveDocument","PcbEngine:enableSelection","PcbEngine:rendererCreated","PcbEngine:setPadAppearance","PcbEngine:clearPadAppearance","PcbEngine:initScenes","PcbEngine:changedRenderMode","PcbEngine:invalidate","PcbEngine:fps","PcbEngine:simulationLoaded","PcbEngine:simulationMouseData","PcbEngine:renderTime","PcbEngine:documentMove","PcbEngine:documentZoom","PcbEngine:resetDocumentView","PcbEngine:documentClick","PcbEngine:renderDocumentData","PcbEngine:documentLocation","PcbEngine:on3DBoardDidRotate","PcbEngine:onSetDocumentLocation","PcbEngine:recoveryLayers","PcbEngine:updateLayers","PcbEngine:toggleObject","PcbEngine:listObjectIds","PcbEngine:toggleUnrotedNet"]}},{key:"activeDocumentIndex",get:function(){return this.currentDocumentIndex}},{key:"allDocuments",get:function(){return this.documents}},{key:"layerManager",get:function(){return this.layerManager_}},{key:"renderMode",get:function(){var e;return null===(e=this.pcbRenderer)||void 0===e?void 0:e.renderMode}},{key:"activeDocument",get:function(){var e;return 0==(null===(e=this.documents)||void 0===e?void 0:e.length)||this.currentDocumentIndex>this.documents.length?null:this.documents[this.currentDocumentIndex]}},{key:"changeProbeState",value:function(e){this.simulationManager.probeEnabled=e}},{key:"init",value:(d=fn(sn().mark((function e(){return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.engineFsm.goToInit();case 2:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"showView",value:(f=fn(sn().mark((function e(t,n){var r;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.activeDocument,e.next=3,this.engineFsm.goToLoad(r);case 3:return e.next=5,this.engineFsm.goToRender(r);case 5:return e.next=7,this.engineFsm.goToShow(t,n);case 7:this.lastLoadedDocumentName!=r.name&&this.canvasControl.restoreRendererState(),this.lastLoadedDocumentName=r.name;case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"handleOutdatedSimulation",value:function(e){this.simulationManager.handleOutdatedSimulation(e)}},{key:"hideView",value:function(){this.canvasControl&&this.canvasControl.peformanceMonitor.stopFpsMeter()}},{key:"resetView",value:function(){this.pcbRenderer&&(this.pcbRenderer.zoomToFit(500),this.canvasControl.invalidate(),r.a.bus.emit("PcbEngine:resetDocumentView",{type:"reset"}),this.pcbRenderer.emitDocumentLocation2D())}},{key:"doSetup",value:function(e){var t=this,n=e.response;if(on.a.instance.attach(n.metadata),!n)throw this.logger.LogError("Response is empty."),new Error("Response is empty.");this.onCreatedScene2D=this.onCreatedScene2D.bind(this),this.metadata=n.metadata,r.a.bus.on("GraphiteEngine:createdScene2D",this.onCreatedScene2D),r.a.bus.once("ParentConnection:setDocumentLocationPCB",(function(e){t.currentDocumentLocation=e})),r.a.bus.once("ParentConnection:setDocumentLocation3D",(function(e){t.currentDocumentLocation=e})),r.a.bus.on("PcbEngine:flipped",(function(){t.pcbRenderer.emitDocumentLocation2D()})),r.a.bus.on("PcbEngine:on3DBoardDidRotate",(function(){t.pcbRenderer.emitDocumentLocation3D()})),r.a.bus.on("PcbEngine:onSetDocumentLocation",(function(e){"pcb"===e&&t.pcbRenderer.emitDocumentLocation2D(),"3d"===e&&t.pcbRenderer.emitDocumentLocation3D()})),r.a.bus.on("PcbEngine:initScenes",(function(e,n,r){t.addUnroutedNets(e,r),setTimeout((function(){t.currentDocumentLocation&&("pcb"===t.currentDocumentLocation.type&&t.setPcbLocation(e,t.currentDocumentLocation),"3d"===t.currentDocumentLocation.type&&t.set3dLocation(n,t.currentDocumentLocation),t.currentDocumentLocation=null)}),50)})),r.a.bus.on("PcbEngine:initScenes",(function(e,n,r){return t.initPadAppearanceManager(e,n,r)})),r.a.bus.on("PcbEngine:setPadAppearance",(function(e){return t.setPadAppearance(e)})),r.a.bus.on("PcbEngine:clearPadAppearance",(function(){return t.clearPadAppearance()})),r.a.bus.on("PcbEngine:invalidate",(function(){return t.canvasControl.invalidate()})),this.onStorageRefresh=this.onStorageRefresh.bind(this),r.a.bus.on("storageRefreshComplete",this.onStorageRefresh),r.a.bus.on("PcbEngine:recoveryLayers",(function(e){t.recoveryLayers=e})),r.a.bus.on("PcbEngine:listObjectIds",(function(e){t.listObjectIds=e})),r.a.bus.on("PcbEngine:toggleObject",(function(e){var n=t.listObjectIds[null==e?void 0:e.kind];n&&(t.pcbRenderer.getSceneCurrent().setNodeItemsVisibility(n.ids,e.visible),t.pcbRenderer.getSceneCurrent().setDirty(!0),t.pcbRenderer.render())})),r.a.bus.on("PcbEngine:setActiveDocument",(function(e){var n=t.documents.find((function(t){return t.altiumDesignerId===e}));n&&t.setActiveDocument(n.id)})),this.setupDocuments(n)}},{key:"setPcbLocation",value:function(e,t){(e||t)&&(e.viewport.SetCenter([t.left,t.top]),e.viewport.SetZoom(t.zoom),this.canvasControl.invalidate(),this.pcbRenderer.emitDocumentLocation2D())}},{key:"set3dLocation",value:function(e,t){if(e||t){var n=(null==t?void 0:t.matrix)||"";null!=n&&n.eye&&null!=n&&n.at&&null!=n&&n.up&&e.viewport.ViewSetLookAt(n.eye,n.at,n.up),this.canvasControl.invalidate(),this.pcbRenderer.emitDocumentLocation3D()}}},{key:"doInit",value:(l=fn(sn().mark((function e(){var t;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(Ge.a)(),e.prev=1,t=new rn.a,e.next=5,t.loadLibs();case 5:return e.next=7,this.resolveGraphite();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),this.logger.LogError("Init error.",e.t0);case 12:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(){return l.apply(this,arguments)})},{key:"doLoad",value:(s=fn(sn().mark((function e(t){var n,i=this;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.lastLoadedDocumentName!=t.name){e.next=2;break}return e.abrupt("return");case 2:return n="Load document error.",e.prev=3,this.canvasControl.saveRenderState(),this.currentPcbRenderer=this.canvasControl.createRenderer(t.id),this.pcbRenderer.renderModeChanged.on((function(){i.canvasControl&&i.canvasControl.peformanceMonitor.startFpsMeter(1e3)})),e.next=9,this.loadDocument(t);case 9:this.selectionItemsObserver.setup(this.pcbRenderer);try{r.a.bus.emit("PcbEngine:documentChanged",t)}catch(e){this.logger.LogError("PcbEngine:documentChanged emit error. "+e.message)}e.next=21;break;case 13:if(e.prev=13,e.t0=e.catch(3),this.logger.LogError(n,e.t0),!(e.t0 instanceof $e.d||e.t0.code===$e.a.StoreExpired)){e.next=20;break}throw e.t0;case 20:throw new Error(n);case 21:case"end":return e.stop()}}),e,this,[[3,13]])}))),function(e){return s.apply(this,arguments)})},{key:"doRender",value:function(e){if(this.lastLoadedDocumentName!=e.name)try{r.a.bus.emit("PcbEngine:dataReadyForSnappingProcessing",e.renderData,this.metadata),this.canvasControl.loadData(e.renderData,this.metadata.projectTypeName),r.a.bus.emit("PcbEngine:didDocumentAttach",{id:e.id,name:e.displayName,altiumDesignerId:e.altiumDesignerId})}catch(t){throw"string"==typeof t?this.logger.LogError(t):this.logger.LogError("Error ".concat(t.name,": ").concat(t.message,"\n").concat(t.stack)),r.a.bus.emit("PcbEngine:didDocumentAttachError",{error:t,isMain:e.isMain}),new Error("Render document error.")}}},{key:"doShow",value:function(e,t){var n,r,i=this,o=this.canvasControl.getContainerId(),a=document.getElementById(o);if(!a)throw new Error("Paint has not found.");e.contains(a)||e.appendChild(a),this.pcbRenderer.renderMode=t,null===(n=this.selectionItemsObserver)||void 0===n||n.setRenderMode(t),null===(r=this.selectionNodesObserver)||void 0===r||r.setRenderMode(t),this.canvasControl.onResize(),this.canvasControl.invalidate(),this.canvasControl.peformanceMonitor.startFpsMeter(1e3),this.pcbLoaded=!0,this.simulationManager.simulationEnabled&&this.showSimulation(),this.currentDocumentLocation||setTimeout((function(){2===t&&i.pcbRenderer.emitDocumentLocation2D(),3===t&&i.pcbRenderer.emitDocumentLocation3D()}),100)}},{key:"hideSimulation",value:function(){var e,t=null===(e=this.activeDocument)||void 0===e?void 0:e.simulation;t&&!t.loading&&t.items.some((function(e){return e.data}))&&t.shown&&(this.simulationManager.hideSimulation(),r.a.bus.emit("select",null),r.a.bus.emit("PcbEngine:enableSelection",!0),this.logger.LogDebug("Simulation hidden"),t.shown=!1)}},{key:"loadSimulation",value:(u=fn(sn().mark((function e(t){var n,i,o,a,c,u,s,l;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.activeDocument){e.next=4;break}return this.logger.LogDebug("Simulation won't load - no document"),e.abrupt("return",Promise.resolve(!1));case 4:if((i=n.simulation)||(i={items:t,loading:!1,shown:!1,loaded:!1},n.simulation=i),!i.loading){e.next=9;break}return this.logger.LogDebug("Simulation is already loading"),e.abrupt("return",Promise.resolve(!1));case 9:if(!i.loaded){e.next=12;break}return this.logger.LogDebug("Simulation loaded"),e.abrupt("return",Promise.resolve(!0));case 12:this.logger.LogDebug("Start loading simulation data..."),i.loading=!0,o=this.simulationManager,a=cn(i.items),e.prev=16,a.s();case 18:if((c=a.n()).done){e.next=44;break}if((u=c.value).url){e.next=23;break}return this.logger.LogDebug("".concat(u.type," document is not present")),e.abrupt("continue",42);case 23:s=void 0,e.t0=u.type.toLowerCase(),e.next=e.t0==="AnsysEDB".toLowerCase()||e.t0==="Signal Integrity".toLowerCase()?27:e.t0==="PDNAnalyzer".toLowerCase()?31:35;break;case 27:return e.next=29,o.loadSimulationAnsysData(u.url);case 29:return s=e.sent,e.abrupt("break",37);case 31:return e.next=33,o.loadSimulationData(u.url);case 33:return s=e.sent,e.abrupt("break",37);case 35:return this.logger.LogWarn("Unsupported type of simulation ".concat(u.type)),e.abrupt("break",37);case 37:if(s){e.next=39;break}return e.abrupt("continue",42);case 39:u.data=s,l=o.getUniqueNetNames(s),r.a.bus.emit("PcbEngine:simulationLoaded",{kind:u.data.kind,type:u.type,data:s,nets:l,url:u.url});case 42:e.next=18;break;case 44:e.next=49;break;case 46:e.prev=46,e.t1=e.catch(16),a.e(e.t1);case 49:return e.prev=49,a.f(),e.finish(49);case 52:return i.loading=!1,i.loaded=!0,this.logger.LogDebug("Simulation data loaded"),e.abrupt("return",!0);case 56:case"end":return e.stop()}}),e,this,[[16,46,49,52]])}))),function(e){return u.apply(this,arguments)})},{key:"showSimulation",value:function(e,t,n){var i,o=null===(i=this.documents[0])||void 0===i?void 0:i.simulation;if(o&&!o.loading){var a,c,u=o.items;if(!e)if(this.currentSimulationType)e=this.currentSimulationType;else if(!(e=null===(a=u.find((function(e){return e.data})))||void 0===a||null===(c=a.data)||void 0===c?void 0:c.kind))return void this.logger.LogWarn("Default simulation data is not found");this.currentSimulationType=e;var s=u.find((function(t){return t.data&&t.data.kind===e}));s&&s.data?(this.simulationManager.showSimulationData(s.data,e,t,n),o.shown=!0,this.logger.LogDebug("Simulation data added to scene"),this.pcbLoaded?(r.a.bus.emit("select",null),r.a.bus.emit("PcbEngine:enableSelection",!1),this.simulationManager.startRendering()):this.logger.LogDebug("Simulation ready to render, but PCB is not loaded yet")):this.logger.LogWarn("There isn't data for show ".concat(e))}}},{key:"selectSimulationViewOption",value:function(e){this.simulationManager.selectSimulationViewOption(e)&&this.showSimulation()}},{key:"loadDocument",value:(c=fn(sn().mark((function e(t){var n;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.errorState){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.getRenderData(t);case 5:if(n=e.sent,t.renderData=n,t.isLoaded=!0,n){e.next=10;break}throw new Error("Document is empty.");case 10:e.next=16;break;case 12:throw e.prev=12,e.t0=e.catch(2),t.errorState=e.t0,e.t0;case 16:case"end":return e.stop()}}),e,this,[[2,12]])}))),function(e){return c.apply(this,arguments)})},{key:"getRenderData",value:(a=fn(sn().mark((function e(t){var n,i,o,a;return sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.id,this.renderDataMap.has(n)){e.next=10;break}return i=r.a.response.storage,e.next=5,i.documentLoader.loadDocument(t.fileData.originalName,t.fileData.fileType);case 5:return o=e.sent,e.next=8,o.arrayBuffer();case 8:a=e.sent,this.renderDataMap.set(n,a);case 10:return e.abrupt("return",this.renderDataMap.get(n));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getBackgroundColor",value:function(){var e,t=null===(e=this.metadata)||void 0===e?void 0:e.projectTypeName,n=function(e){return e=e.map((function(e,t){return t<3?255*e:e})),"rgba(".concat(e.join(","),")")};return n("Eagle"==t||"KiCad"==t?Y.b:Y.a)}},{key:"resolveGraphite",value:function(){var e=this;return new Promise((function(t,n){(new nn.a).on("COMPLETED",(function(){e.controlDiv=window.document.createElement("div"),e.controlDiv.style.display="none",window.document.body.appendChild(e.controlDiv),e.canvasControl=new Y.c(e.controlDiv,new S.d,e.getBackgroundColor(),"PCBView",e.simulationManager),e.canvasControl.peformanceMonitor.on("aggregateFps",(function(t){return r.a.bus.emit("PcbEngine:fps",t,e.pcbRenderer.renderMode)})),e.canvasControl.peformanceMonitor.on("renderTime",(function(t,n){return r.a.bus.emit("PcbEngine:renderTime",t,n,e.pcbRenderer.renderMode)})),t()})).on("CRASHED",(function(e){return n(e)})).init()}))}},{key:"definePreviewUrlProperty",value:function(e,t,n,r){Object.defineProperty(e,2===r?"previewUrl2D":"previewUrl3D",{get:function(){var e,i;return null!==(e=null===(i=t.files.find((function(e){return"Preview"===e.fileType&&e.originalName===n&&e.dataFileUrl.toLowerCase().includes(2===r?"_2d.png":"_3d.png")})))||void 0===i?void 0:i.dataFileUrl)&&void 0!==e?e:""}})}},{key:"getPcbGraphitDocuments",value:function(e){var t=this,n=[];return e&&e.files&&e.files.filter((function(e){return"PcbGraphiteData"===e.fileType})).forEach((function(r,i){var o={id:i.toString(),previewUrl2D:"",previewUrl3D:"",isLoaded:!1,name:r.originalName,displayName:r.originalName,renderData:null,errorState:null,fileData:r};t.definePreviewUrlProperty(o,e,r.originalName,2),t.definePreviewUrlProperty(o,e,r.originalName,3),o.toString=function(){return"[".concat(o.id,"] ").concat(o.name," [").concat(o.isLoaded?"Lodaed":"Not Loaded","]")},n.push(o)})),n}},{key:"setupDocuments",value:function(e){var t,n,r,o=this;if(!e)throw new Error("Response is empty");var a=this.getPcbGraphitDocuments(e.storage);if(0===a.length)throw new Error("No documents to display");var c=null===(t=e.metadata)||void 0===t||null===(n=t.documents)||void 0===n?void 0:n.filter((function(e){return e.kind===i.a.Pcb})),u=null===(r=e.metadata)||void 0===r?void 0:r.pcbDocument,s=null!=c&&c.length?c:[u];s.length&&s.forEach((function(e){var t=e.fileName,n=a.find((function(e){return e.name==t}));n?(n.altiumDesignerId=e.id,n.id=e.fileName?e.fileName:"DEFAULT",n.isMain="boolean"!=typeof e.active||e.active,o.documents.push(n),n.isMain&&o.setActiveDocument(n.name)):o.logger.LogWarn("!!!! sortPcbDataByMetadata: ".concat(t))})),u&&this.simulationManager.useOriginPoint(u.originX,u.originY)}},{key:"onRecoveryLayers",value:function(){var e=(this.layerManager_.getGroupedLayers()||[]).flat().reduce((function(e,t){return t.isActive&&(e.active=t.metaId),t.isVisible&&e.visible.push(t.metaId),e}),{active:null,visible:[]});JSON.stringify(this.recoveryLayers)!==JSON.stringify(e)&&this.layerManager_.recoveryLayers(this.recoveryLayers)}},{key:"setActiveDocument",value:function(e){var t;this.currentDocumentIndex=this.documents.findIndex((function(t){return t.name==e})),this.selectionItemsObserver.convertSelectedItemForDocument(null===(t=this.activeDocument)||void 0===t?void 0:t.altiumDesignerId)}},{key:"onCreatedScene2D",value:function(e){var t=this;if(this.layerFactory){var n,i,o;this.layerManager_=this.layerFactory.createLayerManager(e,null===(n=this.activeDocument)||void 0===n?void 0:n.altiumDesignerId),this.layerManager_.resetLayers(),null===(i=this.selectionNodesObserver)||void 0===i||i.dispose();var a=null===(o=this.activeDocument)||void 0===o?void 0:o.altiumDesignerId;this.selectionNodesObserver=new S.i(this.layerManager_,a,this.simulationManager),r.a.bus.emit("BoardItemsVisibility:setLayerRecoveryData",this.layerManager_.getGroupedLayers()),this.recoveryLayers&&this.onRecoveryLayers(),r.a.bus.emit("PcbEngine:layerManagerCreated",this.layerManager_),r.a.bus.on("LayerManager:changedLayers",(function(){return t.canvasControl.invalidate()})),r.a.bus.on("PcbEngine:flipped",(function(){return t.canvasControl.invalidate()})),r.a.bus.on("PcbEngine:updateLayers",(function(e){t.layerManager_.recoveryLayers(e)}))}}},{key:"initPadAppearanceManager",value:function(e,t,n){e&&t&&(this.padAppearanceManager=new Z(e,t,n),this.canvasControl.invalidate())}},{key:"setPadAppearance",value:function(e){if(this.padAppearanceManager){var t=performance.now();try{this.padAppearanceManager.clearPadAppearance(),this.padAppearanceManager.setPadAppearance(this.layerManager,e,null),this.canvasControl.invalidate(),this.logger.LogDebug("setPadAppearance "+(performance.now()-t))}catch(e){this.logger.LogError("Set pad appearences.\n Error ".concat(e.name,": ").concat(e.message,"\n").concat(e.stack))}}}},{key:"clearPadAppearance",value:function(){var e;null===(e=this.padAppearanceManager)||void 0===e||e.clearPadAppearance(),this.canvasControl.invalidate()}},{key:"addUnroutedNets",value:function(e,t){var n=this;if(e){var i,o,a=new Xe(e,null===(i=this.activeDocument)||void 0===i?void 0:i.altiumDesignerId);null===(o=this.unroutedConnectionBuilder)||void 0===o||o.dispose(),this.unroutedConnectionBuilder=a,a.addConnectionsToScene(t).then((function(){return n.canvasControl.invalidate()})),r.a.bus.on("PcbEngine:toggleUnrotedNet",(function(e){a.toggleVisibleUnroutedLines(e.visible).then((function(){n.canvasControl.invalidate(),n.pcbRenderer.getSceneCurrent().setDirty(!0),n.pcbRenderer.render()}))})),this.selectionItemsObserver.selectedItem&&a.onSelectedItem(this.selectionItemsObserver.selectedItem)}}},{key:"onStorageRefresh",value:function(){var e,t=this;this.getPcbGraphitDocuments(null===(e=r.a.response)||void 0===e?void 0:e.storage).forEach((function(e){var n=t.documents.find((function(t){return t.name===e.name}));n&&(n.previewUrl2D=e.previewUrl2D,n.previewUrl3D=e.previewUrl3D)}))}}])&&dn(t.prototype,n),o&&dn(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}(),yn={type:"Engine",name:"PcbEngine",description:"Presents PCB documents engine module",create:function(){return new pn}};r.a.addModule(yn)}});